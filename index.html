<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²é£Ÿåº—çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (ver1.4.9 - ã‚¿ãƒƒãƒ—é ˜åŸŸæ”¹å–„)</title>
    <style>
        /* --- CSS: ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© --- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* mobile-mode ã‚’ body ã«ä»˜ã‘å¤–ã—ã™ã‚‹ã“ã¨ã§åˆ‡ã‚Šæ›¿ãˆ */
        body.mobile-mode {
            padding: 10px;
        }

        #game-container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 900px;
            padding: 30px;
        }

        body.mobile-mode #game-container {
            width: 100%;
            max-width: 480px;
            padding: 16px;
            border-radius: 10px;
        }

        h1, h2 {
            color: #4CAF50;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .screen {
            display: none;
            /* åˆæœŸã¯å…¨ã¦éè¡¨ç¤º */
        }

        .screen.active {
            display: block;
            /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç”»é¢ã®ã¿è¡¨ç¤º */
        }

        .option-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* --- ä¿®æ­£: ãƒœã‚¿ãƒ³ã®ã‚¿ãƒƒãƒ—é ˜åŸŸã¨é…ç½®ã‚’æ”¹å–„ --- */
        .button-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®ã«å¯„ã›ã‚‹ */
        }

        .button-list button, .action-btn, .button-list a {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px; /* ã‚¿ãƒƒãƒ—é ˜åŸŸã‚’åºƒã’ã‚‹ */
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
            box-sizing: border-box; 
            touch-action: manipulation; /* ã‚¿ãƒƒãƒã®é…å»¶å›é¿ (iOS/Android) */
        }
        
        /* ğŸ’¡ ä¿®æ­£: å­è¦ç´ ã« pointer-events: none; ã‚’é©ç”¨ã—ã¦è¦ªã«ã‚¯ãƒªãƒƒã‚¯ã‚’é€šã™ */
        .button-list button > *, .action-btn > * {
            pointer-events: none;
        }

        .button-list button:hover, .action-btn:hover, .button-list a:hover {
            background-color: #0b7dda;
        }
        .button-list button:active, .action-btn:active, .button-list a:active {
            transform: scale(0.98);
        }

        /* ã‚²ãƒ¼ãƒ å®Ÿè¡Œç”»é¢ã®UI */
        #game-ui {
            display: grid;
            grid-template-areas: 
                "header header"
                "main sidebar";
            grid-template-columns: 3fr 1fr; 
            gap: 15px;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ã¯1ã‚«ãƒ©ãƒ ã« */
        body.mobile-mode #game-ui {
            grid-template-areas:
                "header"
                "main"
                "sidebar";
            grid-template-columns: 1fr;
        }

        #header-bar {
            grid-area: header;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
            gap: 8px;
            flex-wrap: wrap; /* ãƒœã‚¿ãƒ³ãŒå¤šã„ã®ã§æŠ˜ã‚Šè¿”ã™ */
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³ç¾¤ã‚’æŠ˜ã‚ŠãŸãŸã¿ã‚„ã™ãã™ã‚‹ (paddingã‚’å°ã•ãä¿ã¤) */
        #header-bar .left-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        #header-bar .left-buttons button {
             padding: 8px 12px;
             margin: 3px;
        }

        /* ã‚¹ãƒãƒ›ãƒ¢ãƒ¼ãƒ‰ã®å¤§ãã‚ãƒœã‚¿ãƒ³ */
        body.mobile-mode .button-list button, body.mobile-mode .action-btn {
            padding: 14px 16px; /* ã•ã‚‰ã«é ˜åŸŸã‚’æ‹¡å¤§ */
            font-size: 16px;
            margin: 6px 3px;
            width: calc(50% - 6px); /* 2åˆ—ã§é…ç½®ã—ã‚„ã™ã */
        }

        #main-game-area {
            grid-area: main;
            min-height: 400px;
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 20px;
        }
        
        body.mobile-mode #main-game-area {
            min-height: 300px;
            padding: 12px;
        }

        #sidebar-info {
            grid-area: sidebar;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ccc;
        }
        
        #sidebar-info h3 {
            margin-top: 0;
            color: #4CAF50;
        }

        #status-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #388e3c;
        }

        #log-terop {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px 5px 0 0;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1000;
        }
        
        /* === å¸­ãƒãƒƒãƒ—ã¨å®¢ã®çŠ¶æ…‹ --- ä¿®æ­£: å¸­å…¨ä½“ã‚’ã‚¿ãƒƒãƒ—é ˜åŸŸã« === */
        #seat-map {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #seat-map div {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
            min-width: 100px;
            text-align: center;
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠé˜²æ­¢ */
            touch-action: manipulation; /* ã‚¿ãƒƒãƒ—ã®é…å»¶å›é¿ */
        }
        /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªå¸­ï¼ˆonclickå±æ€§ã‚’æŒã¤divï¼‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        #seat-map div[onclick] {
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        #seat-map div[onclick]:active {
            transform: scale(0.98);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚°ãƒªãƒƒãƒ‰ã«ã—ã¦è¦‹ã‚„ã™ã */
        body.mobile-mode #seat-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }
        body.mobile-mode #seat-map div {
            margin: 0;
            padding: 12px;
            font-size: 1em;
            min-width: 0;
        }

        .seat-empty { background-color: #ddffdd; border: 1px solid #4CAF50; }
        .seat-occupied-wait { background-color: #fffacd; border: 1px solid #ffc107; color: #333; }
        .seat-occupied-eat { background-color: #ffdddd; border: 1px solid #f44336; color: #333; }
        .seat-occupied-confirmation { background-color: #ADD8E6; border: 1px solid #1E90FF; color: #333; } /* æ³¨æ–‡ç¢ºèªå¾…ã¡ */
        .seat-occupied-payment { background-color: #90EE90; border: 1px solid #008000; color: #333; } /* ä¼šè¨ˆå¾…ã¡ */

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«CSS --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            padding-top: 50px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }
        .employee-item, .menu-item-row, .item-list-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
        }
        .menu-item-row input[type="number"] {
            width: 80px;
            text-align: right;
            margin-left: 10px;
        }

        /* --- å®¢ã¨ã®ä¼šè©±å¹ãå‡ºã— --- */
        #customer-dialogue-box {
            display: none;
            position: fixed;
            top: 20%; 
            left: 50%;
            transform: translate(-55%, -50%); /* ä¿®æ­£ */
            width: 80%;
            max-width: 400px;
            background: white;
            border: 5px solid #4CAF50;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            text-align: left;
        }
        #customer-dialogue-box:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: #4CAF50;
            border-bottom: 0;
            margin-left: -15px;
            margin-bottom: -15px;
        }
        #dialogue-text {
            font-size: 1.1em;
            min-height: 50px;
        }
        .dialogue-customer-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid #333;
        }
        .dialogue-speaker {
            font-weight: bold;
            color: #4CAF50;
        }
        /* ğŸ’¡ ä¿®æ­£: ä¼šè©±ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚‚ã‚¿ãƒƒãƒ—é ˜åŸŸã‚’åºƒã’ã‚‹ */
        #dialogue-options button {
             padding: 12px 20px; 
             margin: 5px;
             touch-action: manipulation;
        }

        /* --- ãƒ¬ã‚¸UI (Register Modal) --- */
        .cash-register {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
            width: 100%;
            max-width: 550px;
            margin: 0 auto;
        }
        .register-display {
            background-color: #000;
            color: #00FF00;
            font-size: 2em;
            padding: 10px;
            border-radius: 5px;
            text-align: right;
            margin-bottom: 15px;
            border: 2px solid #008000;
        }
        .register-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .coin-tray, .payment-area {
            background-color: #555;
            padding: 10px;
            border-radius: 5px;
            min-height: 150px;
        }
        .coin-tray h4 {
            margin-top: 0;
            color: #ccc;
        }
        .coin-selector button, .payment-area button {
            width: 65px;
            height: 40px;
            background-color: #FFD700;
            color: #333;
            border: 1px solid #DAA520;
            margin: 3px;
            font-weight: bold;
            padding: 5px;
            /* ğŸ’¡ ä¿®æ­£: ã‚³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚‚ã‚¿ãƒƒãƒ—é ˜åŸŸã‚’åºƒã’ã‚‹ */
            touch-action: manipulation; 
        }
        .payment-input input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            font-size: 1.2em;
            text-align: right;
        }
        #register-message {
            margin-top: 10px;
            color: yellow;
            font-weight: bold;
        }

        /* å°ã•ã„ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼ˆè£œåŠ©ï¼‰ */
        @media (max-width: 480px) {
            #game-container { padding: 12px; }
            #main-game-area { padding: 12px; }
            .modal-content { width: 92%; padding: 12px; }
            .register-controls { grid-template-columns: 1fr; }
            .coin-selector button, .payment-area button { width: 50px; height: 35px; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="home-screen" class="screen active">
        <h1>ã‚ˆã†ã“ãï¼é£²é£Ÿåº—çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¸</h1>
        <div class="button-list" style="text-align: center;">
            <button onclick="showScreen('start-screen')">æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹</button>
            <button onclick="loadGameFromHome()">ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
            <a href="https://tamani3901.github.io/ti-tobann/" target="_blank" style="background-color: #ff5722;">ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œç‰ˆã¸</a> 
        </div>
    </div>

    <div id="start-screen" class="screen">
        <h2>æ–°è¦ã‚²ãƒ¼ãƒ è¨­å®š</h2>
        
        <div id="step-type" class="option-group">
            <h3>1. åº—ã®ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
            <div class="button-list">
                <button data-type="FastFood" onclick="selectType('FastFood')">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰</button>
                <button data-type="Restaurant" onclick="selectType('Restaurant')">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</button>
            </div>
            <p id="type-info"></p>
        </div>

        <div id="step-location" class="option-group" style="display: none;">
            <h3>2. å ´æ‰€ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
            <div class="button-list">
                <button data-loc="å¤§éƒ½å¸‚éƒ¨" data-max="10" onclick="selectLocation('å¤§éƒ½å¸‚éƒ¨', 10)">å¤§éƒ½å¸‚éƒ¨ (æœ€å¤§10å¸­)</button>
                <button data-loc="éƒ½å¸‚éƒ¨" data-max="7" onclick="selectLocation('éƒ½å¸‚éƒ¨', 7)">éƒ½å¸‚éƒ¨ (æœ€å¤§7å¸­)</button>
                <button data-loc="ä¸­éƒ½å¸‚" data-max="5" onclick="selectLocation('ä¸­éƒ½å¸‚', 5)">ä¸­éƒ½å¸‚ (æœ€å¤§5å¸­)</button>
                <button data-loc="å°éƒ½å¸‚" data-max="3" onclick="selectLocation('å°éƒ½å¸‚', 3)">å°éƒ½å¸‚ (æœ€å¤§3å¸­)</button>
            </div>
            <p id="location-info"></p>
        </div>

        <div id="step-size" class="option-group" style="display: none;">
            <h3>3. åº—ã®å¤§ãã•ã‚’æ±ºã‚ã¦ãã ã•ã„ (å ´æ‰€ã«ã‚ˆã‚‹åˆ¶é™ã‚ã‚Šã€æœ€å¤§20å¸­)</h3>
            <p>é¸æŠã—ãŸå ´æ‰€ã§ã®ä¸Šé™: <span id="max-seats"></span>å¸­</p>
            <p>ç¾åœ¨ã®å¸­æ•°: <span id="current-seats">0</span> å¸­ (2äººæ›ã‘ãƒ†ãƒ¼ãƒ–ãƒ« <span id="current-tables">0</span> å€‹)</p>
            <p>åˆæœŸè²»ç”¨: <span id="initial-cost">0</span> å††</p>
            <div class="button-list">
                <button onclick="changeSeats(-2)">å¸­ã‚’æ¸›ã‚‰ã™</button>
                <button onclick="changeSeats(2)">å¸­ã‚’å¢—ã‚„ã™</button>
            </div>
            <p style="font-size:0.9em;color:#666;margin-top:8px;">â€»ã‚²ãƒ¼ãƒ é–‹å§‹å¾Œã‚‚è¨­å®šã‹ã‚‰å¸­æ•°ã‚’å¤‰æ›´å¯èƒ½ï¼ˆä¸Šé™20å¸­ã€å¶æ•°ã®ã¿ï¼‰</p>
        </div>
        
        <div id="step-menu" class="option-group" style="display: none;">
            <h3>4. åˆæœŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ (5å€‹ã¾ã§)</h3>
            <p>é¸æŠä¸­: <span id="selected-menu-count">0</span> / 5</p>
            <div id="menu-selection-area" class="button-list" style="display: flex; flex-wrap: wrap;">
                </div>
        </div>

        <div id="step-start" class="option-group" style="text-align: center; margin-top: 30px; display: none;">
            <button onclick="showConfirmation()" class="action-btn" style="background-color: #4CAF50;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <button onclick="loadGameFromHome()" id="load-game-btn" class="action-btn" style="background-color: #ff9800; margin-left: 10px; display: none;">ãƒ­ãƒ¼ãƒ‰</button>
            <button onclick="resetSetup()" class="action-btn">è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <p id="load-info" style="margin-top: 5px; font-size: 0.9em;"></p>
        </div>
    </div>

    <div id="confirmation-screen" class="screen">
        <h2>è¨­å®šç¢ºèª</h2>
        <p>ä»¥ä¸‹ã®è¨­å®šã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
        <div id="config-summary"></div>
        <div class="button-list" style="text-align: center;">
            <button onclick="startGame()" class="action-btn" style="background-color: #4CAF50;">OK (ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ)</button>
            <button onclick="showScreen('start-screen')" class="action-btn">æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="game-ui">
            <div id="header-bar">
                <div class="left-buttons">
                    <button onclick="showMenu()" class="action-btn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                    <button onclick="showSettings()" class="action-btn">è¨­å®š</button>
                    <button onclick="showItems()" class="action-btn" style="background-color: #3f51b5;">ã‚¢ã‚¤ãƒ†ãƒ </button>
                    <button onclick="saveGame()" class="action-btn" style="background-color: #007bff;">ã‚»ãƒ¼ãƒ–</button>
                    <button onclick="quitGame()" class="action-btn" style="background-color: #f44336;">ã‚„ã‚ã‚‹</button>
                    <button onclick="toggleMobileMode()" class="action-btn" id="mobile-toggle-btn" style="background-color: #009688;">ã‚¹ãƒãƒ›ãƒ¢ãƒ¼ãƒ‰</button>
                    <button onclick="toggleManualMode()" class="action-btn" id="manual-toggle-btn" style="background-color: #ff9800;">æ³¨æ–‡/ä¼šè¨ˆ: æ‰‹å‹•</button> </div>
                <div id="day-time-display">
                    <span id="day-display">Day 1</span> |
                    <span id="time-display">00:00</span>
                </div>
                <div id="status-display">
                    <span id="asset-display">è³‡ç”£: 15,000,000å††</span> |
                    <span id="reputation-display">è©•åˆ¤: â˜…3</span>
                </div>
            </div>
            <div id="main-game-area">
                <h3>åº—èˆ—ã‚¨ãƒªã‚¢ (<span id="store-type-display"></span> / <span id="store-location-display"></span>)</h3>
                <div id="seat-map">
                </div>
            </div>
            <div id="sidebar-info">
                <h3>æƒ…å ±</h3>
                <p>é«˜ç´šã‚´ãƒŸç®±: <span id="garbage-can-status">æœªè³¼å…¥</span></p>
                <h4>å¾“æ¥­å“¡ï¼ˆ<span id="employee-count">0</span>åï¼‰</h4>
                <div id="employee-status">
                </div>
                <hr>
                <h4>å¾…æ©Ÿä¸­ã®ã‚¿ã‚¹ã‚¯</h4>
                <p>æ³¨æ–‡å¾…ã¡(æ‰‹å‹•): <span id="wait-confirm-count">0</span></p> <p>èª¿ç†å¾…ã¡: <span id="wait-cook-count">0</span></p>
                <hr>
                <h4>å®¢ã®è©³ç´°</h4>
                <div id="waiting-customer-details">
                    </div>
            </div>
        </div>
    </div>
</div>

<div id="log-terop"></div>

<div id="customer-dialogue-box">
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <img class="dialogue-customer-img" id="dialogue-img" src="" alt="å®¢ç”»åƒ">
        <span class="dialogue-speaker" id="dialogue-speaker">ãŠå®¢æ§˜</span>
    </div>
    <div id="dialogue-text">...</div>
    <div id="dialogue-options" class="button-list" style="margin-top: 15px;">
        </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <h2>åº—èˆ—è¨­å®š</h2>
        
        <div class="option-group">
            <h3>å¾“æ¥­å“¡ç®¡ç† (ç¾åœ¨ã®äººæ•°: <span id="current-employee-count">0</span>äºº)</h3>
            <div id="employee-list-settings">
                </div>
            <p><strong>æ¡ç”¨:</strong> (æ—¥å½“)</p>
            <div class="button-list">
                <button onclick="addEmployee('ãƒã‚¹ã‚¿ãƒ¼')">ãƒã‚¹ã‚¿ãƒ¼ (45ä¸‡)</button> <button onclick="addEmployee('ãƒ™ãƒ†ãƒ©ãƒ³')">ãƒ™ãƒ†ãƒ©ãƒ³ (30ä¸‡)</button>
                <button onclick="addEmployee('æ¨™æº–')">æ¨™æº– (20ä¸‡)</button>
                <button onclick="addEmployee('ãƒãƒ³ã‚³ãƒ„')">ãƒãƒ³ã‚³ãƒ„ (10ä¸‡)</button>
            </div>
        </div>
        <div class="option-group">
            <h3>å¸­æ•°ã®å¤‰æ›´ï¼ˆã‚²ãƒ¼ãƒ ä¸­ã«åæ˜ ã•ã‚Œã¾ã™ï¼‰</h3>
            <p>ç¾åœ¨ã®å¸­æ•°: <strong id="in-game-seats-display">0</strong> å¸­</p>
            <div class="button-list">
                <button onclick="changeSeatsInGame(-2)">å¸­ã‚’æ¸›ã‚‰ã™</button>
                <button onclick="changeSeatsInGame(2)">å¸­ã‚’å¢—ã‚„ã™</button>
            </div>
            <p style="font-size:0.9em;color:#666;margin-top:8px;">
                ä¸Šé™: 20å¸­ã€‚å¸­ã¯å¶æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
                æ¸›ã‚‰ã™å ´åˆã€å‰Šé™¤å¯¾è±¡ã®å¸­ã«å®¢ãŒã„ã‚‹ã¨æ¸›ã‚‰ã›ã¾ã›ã‚“ã€‚
            </p>
        </div>

        <div class="option-group">
            <h3>è³‡ç”£è¨­å®š</h3>
            <p>
                <label>
                    <input type="checkbox" id="infinite-asset-toggle" onchange="toggleInfiniteAsset()"> 
                    è³‡ç”£ã‚’ç„¡åˆ¶é™ã«ã™ã‚‹
                </label>
            </p>
        </div>

        <div class="option-group">
            <h3>ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œï¼ˆã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ï¼‰</h3>
            <div class="button-list">
                <button onclick="downloadSaveFile()" class="action-btn" style="background-color: #ff9800;">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <p><strong>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€:</strong></p>
            <input type="file" id="load-file-input" accept=".json" onchange="loadGameFromFile(event)" style="margin-top: 10px;">
        </div>
        
        <button onclick="closeModal('settings-modal')" class="action-btn">è¨­å®šã‚’é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="menu-modal" class="modal">
    <div class="modal-content">
        <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ã¨ä¾¡æ ¼èª¿æ•´</h2>
        <p>â€»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¾¡æ ¼ã¯ã“ã“ã§èª¿æ•´ã§ãã¾ã™ã€‚</p>
        
        <div class="option-group">
            <h3>ç¾åœ¨ã®æä¾›ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (<span id="menu-count">0</span>å€‹)</h3>
            <div id="current-menu-list">
                </div>
        </div>

        <div class="option-group">
            <h3>æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ </h3>
            <p>
                <button onclick="showAllMenuOptions()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º</button>
            </p>
            <div id="all-menu-options" style="display: none; border: 1px dashed #ccc; padding: 10px;">
                </div>
        </div>

        <button onclick="closeModal('menu-modal')" class="action-btn">ç®¡ç†ã‚’çµ‚äº†</button>
    </div>
</div>

<div id="item-modal" class="modal">
    <div class="modal-content">
        <h2>ã‚¢ã‚¤ãƒ†ãƒ è³¼å…¥</h2>
        <p>è³¼å…¥ã—ãŸã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
        
        <div id="item-list-purchase" class="option-group">
            </div>

        <button onclick="closeModal('item-modal')" class="action-btn">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="register-modal" class="modal">
    <div class="modal-content">
        <h2>æ‰‹å‹•ä¼šè¨ˆãƒ¬ã‚¸</h2>
        <div class="cash-register">
            <div id="register-display-area" class="register-display">
                <p id="register-total" style="font-size: 0.6em; margin: 0; color: #88ff88;">åˆè¨ˆ: Â¥0</p>
                <p id="register-received" style="margin: 0;">å—å–é¡: Â¥0</p>
            </div>
            <div class="register-controls">
                <div class="payment-area">
                    <h4>å®¢ãŒæ¸¡ã—ãŸãŠé‡‘</h4>
                    <div id="register-message"></div>
                    <div class="payment-input">
                        <label for="received-amount-input" style="font-size: 0.9em;">æ¸¡ã•ã‚ŒãŸé‡‘é¡</label>
                        <input type="text" id="received-amount-input" value="0" min="0" oninput="updateRegisterDisplay()">
                    </div>
                    
                    <h4 style="margin-top: 10px;">ãŠé‡£ã‚Šã®ç¨®é¡ (ãƒ‰ãƒ©ãƒƒã‚°ç›¸å½“)</h4>
                    <div id="coin-change-tray" class="coin-selector">
                        </div>
                    <button onclick="giveChange()" class="action-btn" style="background-color: #f44336; width: 100%;">ãŠé‡£ã‚Šã‚’æ¸¡ã™</button>
                </div>
                <div class="coin-tray">
                    <h4>ä¼šè¨ˆæƒ…å ±</h4>
                    <p>è«‹æ±‚é‡‘é¡: <strong id="bill-amount-display">0</strong> å††</p>
                    <p>å—å–åˆè¨ˆ: <strong id="received-total-display">0</strong> å††</p>
                    <p>å¿…è¦ãªãŠé‡£ã‚Š: <strong id="change-due-display" style="color: yellow;">0</strong> å††</p>
                    <hr>
                    <h4>æŠ•å…¥ã—ãŸãŠé‡£ã‚Š</h4>
                    <p>æ¸¡ã—ãŸãŠé‡£ã‚Šåˆè¨ˆ: <strong id="change-given-display" style="color: #00FF00;">0</strong> å††</p>
                </div>
            </div>
        </div>
        <button onclick="closeModal('register-modal')" class="action-btn" style="margin-top: 20px;">ãƒ¬ã‚¸ã‚’é–‰ã˜ã‚‹(å–å¼•ä¸­æ­¢)</button>
    </div>
</div>


<script>
    // --- ã‚²ãƒ¼ãƒ ã®é™çš„ãƒ‡ãƒ¼ã‚¿ ---

    const MENU_DATA = { 
        FastFood: [
            { name: "ãƒãƒ¼ã‚ºãƒãƒ¼ã‚¬ãƒ¼", basePrice: 500, cost: 200, category: "Burger" },
            { name: "ãƒ†ãƒªãƒ¤ã‚­ãƒãƒ¼ã‚¬ãƒ¼", basePrice: 500, cost: 220, category: "Burger" },
            { name: "ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼", basePrice: 500, cost: 180, category: "Burger" },
            { name: "ç„¼è‚‰ãƒ©ã‚¤ã‚¹ãƒãƒ¼ã‚¬ãƒ¼", basePrice: 500, cost: 250, category: "Burger" },
            { name: "ãƒãƒ†ãƒˆS", basePrice: 200, cost: 50, category: "Side" },
            { name: "ãƒãƒ†ãƒˆM", basePrice: 300, cost: 70, category: "Side" },
            { name: "ãƒãƒ†ãƒˆL", basePrice: 450, cost: 90, category: "Side" },
            { name: "ãƒŠã‚²ãƒƒãƒˆ", basePrice: 300, cost: 100, category: "Side" },
            { name: "ãƒãƒ‹ãƒ©ã‚·ã‚§ã‚¤ã‚¯", basePrice: 300, cost: 80, category: "Shake" },
            { name: "ã„ã¡ã”ã‚·ã‚§ã‚¤ã‚¯", basePrice: 300, cost: 90, category: "Shake" },
            { name: "ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹", basePrice: 300, cost: 50, category: "Drink" },
            { name: "ã‚³ãƒ¼ãƒ©", basePrice: 300, cost: 60, category: "Drink" },
        ],
        Restaurant: [
            { name: "ãƒãƒ«ã‚²ãƒªãƒ¼ã‚¿", basePrice: 1200, cost: 350, category: "Pizza" },
            { name: "ãƒãƒ¼ã‚ºãƒ”ã‚¶", basePrice: 1200, cost: 300, category: "Pizza" },
            { name: "ãƒŠãƒãƒªã‚¿ãƒ³ãƒ‘ã‚¹ã‚¿", basePrice: 1000, cost: 280, category: "Pasta" },
            { name: "ãƒˆãƒãƒˆãƒ‘ã‚¹ã‚¿", basePrice: 1000, cost: 300, category: "Pasta" },
            { name: "ã‚«ãƒ«ãƒœãƒŠãƒ¼ãƒ©", basePrice: 1000, cost: 320, category: "Pasta" },
            { name: "ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­", basePrice: 900, cost: 250, category: "Dessert" },
            { name: "ãƒãƒ³ãƒãƒ¼ã‚°", basePrice: 1300, cost: 400, category: "Main" },
            { name: "ã‚¹ãƒ†ãƒ¼ã‚­", basePrice: 1400, cost: 500, category: "Main" },
            { name: "ã‚µãƒ©ãƒ€", basePrice: 500, cost: 150, category: "Side" },
            { name: "ãƒ‘ãƒ•ã‚§", basePrice: 700, cost: 200, category: "Dessert" },
            { name: "ãƒ—ãƒªãƒ³", basePrice: 400, cost: 120, category: "Dessert" },
            { name: "ã”é£¯", basePrice: 350, cost: 80, category: "Side" },
            { name: "ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹", basePrice: 300, cost: 50, category: "Drink" },
            { name: "ã‚³ãƒ¼ãƒ©", basePrice: 300, cost: 60, category: "Drink" },
        ]
    };
    const ITEM_DATA = {
        GARBAGE_CAN: { name: "é«˜ç´šã‚´ãƒŸç®±", cost: 10000, effect: "å®¢ã®æº€è¶³åº¦æ¸›å°‘é€Ÿåº¦ãŒå°‘ã—ç·©å’Œï¼ˆåŠ¹æœæŒç¶šï¼‰" },
        CLEANING: { name: "æ¸…æƒã‚µãƒ¼ãƒ“ã‚¹", cost: 50000, effect: "åº—ã®è©•åˆ¤ã‚’0.2ä¸Šã’ã‚‹ï¼ˆå³æ™‚åŠ¹æœï¼‰" }
    };
    const costDetails = {
        'å¤§éƒ½å¸‚éƒ¨': 3000000, 'éƒ½å¸‚éƒ¨': 3000000,
        'ä¸­éƒ½å¸‚': 2000000, 'å°éƒ½å¸‚': 2000000,
        'BASE': 3000000 // åº—ã‚’å»ºã¦ã‚‹è²»ç”¨
    };
    const SAVE_KEY = 'restaurant_tycoon_save';
    const GLOBAL_MAX_SEATS = 20;

    // å®¢ã®ç”»åƒãƒªãƒ³ã‚¯ (ä¸€ã¤ã®ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨)
    const CUSTOMER_IMAGE_URL = "https://i.ibb.co/2YPFhJ1D/IMG-2529.jpg";

    // ãƒ¬ã‚¸é–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentTransaction = {
        customerId: null,
        billAmount: 0,
        receivedAmount: 0, // å®¢ãŒæ¸¡ã—ãŸé‡‘é¡
        changeGiven: 0,    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ¸¡ã—ãŸãŠé‡£ã‚Š
        changeCoins: [10000, 5000, 1000, 500, 100, 50, 10, 5, 1], // ä½¿ç”¨ã§ãã‚‹è²¨å¹£
        changeDispensed: {} // æ¸¡ã—ãŸãŠé‡£ã‚Šã®ç¨®é¡ã¨é‡‘é¡
    };


    // =========================================================
    // 0. ã‚¯ãƒ©ã‚¹å®šç¾©
    // =========================================================

    class MenuItem {
        constructor(name, currentPrice, cost) {
            this.name = name;
            this.currentPrice = currentPrice;
            this.cost = cost;
        }
    }

    class Employee {
        constructor(grade, id = Math.random().toString(36).substring(2, 9)) {
            this.grade = grade;
            this.id = id;
            
            switch (grade) {
                case 'ãƒã‚¹ã‚¿ãƒ¼': // è¿½åŠ 
                    this.speedMultiplier = 2.5;
                    this.missRate = 0.0;
                    this.dailyCost = 450000;
                    break;
                case 'ãƒ™ãƒ†ãƒ©ãƒ³':
                    this.speedMultiplier = 1.5;
                    this.missRate = 0.0;
                    this.dailyCost = 300000;
                    break;
                case 'æ¨™æº–':
                    this.speedMultiplier = 1.0;
                    this.missRate = 0.03;
                    this.dailyCost = 200000;
                    break;
                case 'ãƒãƒ³ã‚³ãƒ„':
                    this.speedMultiplier = 0.5;
                    this.missRate = 0.10;
                    this.dailyCost = 100000;
                    break;
            }
        }
        
        getProcessTime(baseTime) {
            return baseTime / this.speedMultiplier;
        }
    }

    class Customer {
        constructor(numPeople, orderType, seatId, menuList) {
            this.id = Math.random().toString(36).substring(2, 9);
            this.numPeople = numPeople; 
            this.orderType = orderType; 
            this.seatId = seatId;
            // WaitOrder, WaitConfirmation, WaitCook, WaitServe, Eating, WaitPayment, Paying, Done
            this.status = 'WaitOrder'; 
            this.patience = 60;
            this.mealTimeLeft = 30;    
            this.billAmount = 0;
            this.totalCost = 0;

            // æ³¨æ–‡ãƒ­ã‚¸ãƒƒã‚¯
            if (menuList && menuList.length > 0) {
                const randomIndex = Math.floor(Math.random() * menuList.length);
                this.orderedItem = menuList[randomIndex];
                this.billAmount = this.numPeople * this.orderedItem.currentPrice;
                this.totalCost = this.numPeople * this.orderedItem.cost;
            } else {
                this.orderedItem = null;
            }
        }

        update(deltaTime) {
            if (this.status === 'Eating') {
                this.mealTimeLeft -= deltaTime;
                if (this.mealTimeLeft <= 0) {
                    // é£Ÿäº‹çµ‚äº†å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å²
                    if (game.isManualMode) {
                        this.status = 'WaitPayment'; // æ”¯æ‰•ã„å¾…ã¡ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¼šè¨ˆã‚’å¾…ã¤ï¼‰
                        terop(`å¸­ ${this.seatId} ã®ãŠå®¢æ§˜ãŒä¼šè¨ˆã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚`);
                    } else {
                        this.status = 'Paying'; // è‡ªå‹•ä¼šè¨ˆï¼ˆæ—¢å­˜ãƒ•ãƒ­ãƒ¼ï¼‰
                    }
                }
            }
            
            // æº€è¶³åº¦ï¼ˆPatienceï¼‰ã®æ¸›ã‚Šæ–¹ã‚’èª¿æ•´ã—ã€ã‚´ãƒŸç®±åŠ¹æœã‚’é©ç”¨
            const baseRate = ['Eating', 'WaitPayment', 'Paying'].includes(this.status) ? 0.3 : 1.0; 
            const garbageCanEffect = game.hasGarbageCan ? 0.8 : 1.0;

            if (this.status !== 'Done') { // Doneã«ãªã£ãŸå®¢ã¯Patienceã‚’æ¸›ã‚‰ã•ãªã„
                this.patience -= deltaTime * baseRate * garbageCanEffect;
            }

            if (this.patience <= 0) {
                // æ€’ã£ã¦å¸°ã‚‹
                if (this.status !== 'Done' && this.status !== 'Paying') { 
                    this.status = 'Done'; // æ€’ã£ã¦å¸°ã‚‹ï¼ˆGameManager.updateã§å‰Šé™¤ã•ã‚Œã‚‹ï¼‰
                }
            }
        }
    }


    // =========================================================
    // 1. GameManager (ã‚²ãƒ¼ãƒ ã®é ­è„³)
    // =========================================================
    class GameManager {
        constructor() {
            this.asset = 15000000;
            this.reputation = 3;
            this.day = 1;
            this.time = 0;
            this.isPaused = false;
            this.isGameRunning = false;
            this.storeType = null;
            this.location = null;
            this.currentSeats = 0;
            
            this.seatsData = [];
            this.customers = [];
            this.employees = []; 
            this.menu = [];

            this.cookQueue = [];
            this.employeeTasks = [];

            this.customerSpawnTimer = 0;
            this.customerSpawnInterval = 10;
            
            this.hasGarbageCan = false;

            // æ‰‹å‹•/è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            this.isManualMode = true; 
        }
        
        resetGame() {
            this.asset = 15000000;
            this.reputation = 3;
            this.day = 1;
            this.time = 0;
            this.isPaused = false;
            this.isGameRunning = false; 

            this.storeType = null;
            this.location = null;
            this.currentSeats = 0;
            
            this.seatsData = [];
            this.customers = [];
            this.employees = []; 
            this.menu = [];
            this.cookQueue = [];
            this.employeeTasks = [];
            this.customerSpawnTimer = 0;
            this.customerSpawnInterval = 10; 
            
            this.hasGarbageCan = false;
            this.isManualMode = true; 
        }

        initializeGame(settings) {
            this.isGameRunning = true;
            this.storeType = settings.type;
            this.location = settings.location;
            this.currentSeats = settings.currentSeats;

            this.menu = settings.initialMenu.map(itemData => new MenuItem(itemData.name, itemData.basePrice, itemData.cost));
            // å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            this.seatsData = [];
            for (let i = 0; i < this.currentSeats / 2; i++) {
                this.seatsData.push({ id: i + 1, isOccupied: false, numGuests: 0, customerId: null });
            }

            // åˆæœŸå¾“æ¥­å“¡ï¼ˆãƒ­ãƒ¼ãƒ‰æ™‚ä»¥å¤–ã¯ã“ã“ã§åˆæœŸåŒ–ï¼‰
            if (this.employees.length === 0) {
                 this.employees = [new Employee('æ¨™æº–'), new Employee('æ¨™æº–'), new Employee('ãƒ™ãƒ†ãƒ©ãƒ³'), new Employee('ãƒãƒ³ã‚³ãƒ„')];
            }
            
            this.customers = [];
            this.cookQueue = [];
            this.employeeTasks = [];

            document.getElementById('store-type-display').textContent = this.storeType;
            document.getElementById('store-location-display').textContent = this.location;

            this.updateDisplay();
        }

        update(deltaTime) {
            // ã€é‡è¦ã€‘ã‚²ãƒ¼ãƒ åœæ­¢ä¸­ã¯ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãªã„
            if (this.isPaused) {
                this.updateDisplay(); // UIã®è¡¨ç¤ºã¯æ›´æ–°ã—ã¦ã€å®¢ã®Patienceã¯æ¸›ã‚‹ã‚ˆã†ã«ã™ã‚‹
                return;
            } 
            
            const GAME_SPEED = 2.0;
            this.time += deltaTime * GAME_SPEED; 

            if (this.time >= 600) {
                this.time = 600;
                this.endOfDay();
                return;
            }

            this.spawnCustomer(deltaTime);
            this.customers.forEach(customer => {
                customer.update(deltaTime);
                
                // ã€ä¿®æ­£ã€‘æ€’ã£ã¦å¸°ã£ãŸå®¢ã®å³æ™‚è§£æ”¾ï¼ˆCustomer.updateã§patienceãŒ0ä»¥ä¸‹ã«ãªã‚‹ã¨status='Done'ã«ãªã‚‹ï¼‰
                if (customer.status === 'Done' && customer.patience <= 0) {
                    this.removeCustomer(customer, customer.seatId, false); // æ€’ã£ã¦å¸°ã£ãŸå ´åˆã¯æ”¯æ‰•ã£ã¦ã„ãªã„
                } else if (customer.status === 'Paying' && !this.isManualMode) {
                    // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§ã®æ”¯æ‰•ã„å®Œäº†å‡¦ç†
                    this.removeCustomer(customer, customer.seatId, true); 
                }
            });
            this.processEmployeeTasks(deltaTime); 

            this.updateDisplay();
        }

        // --- å®¢ã®ç”Ÿæˆã¨ç®¡ç† ---
        spawnCustomer(deltaTime) {
            this.customerSpawnTimer += deltaTime;
            if (this.customerSpawnTimer >= this.customerSpawnInterval) {
                this.customerSpawnTimer = 0;
                const availableSeats = this.seatsData.filter(seat => !seat.isOccupied);
                if (availableSeats.length === 0) {
                    terop('æº€å¸­ã®ãŸã‚ã€ãŠå®¢æ§˜ãŒå¸°ã£ã¦ã—ã¾ã„ã¾ã—ãŸ...');
                    return;
                }

                const numPeople = Math.floor(Math.random() * 4) + 1;
                const orderType = Math.random() < 0.8 ? 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ' : 'æ‰‹å‹•';

                const seatIndex = this.seatsData.findIndex(seat => !seat.isOccupied);
                if (seatIndex !== -1) {
                    const assignedSeat = this.seatsData[seatIndex];
                    const customer = new Customer(numPeople, orderType, assignedSeat.id, this.menu);
                    
                    if (!customer.orderedItem) {
                        terop('æä¾›ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å®¢ãŒå¸°ã‚Šã¾ã—ãŸã€‚');
                        return;
                    }

                    assignedSeat.isOccupied = true;
                    assignedSeat.numGuests = customer.numPeople;
                    assignedSeat.customerId = customer.id;
                    
                    this.customers.push(customer);
                    
                    // æ³¨æ–‡ãƒ•ãƒ­ãƒ¼ã®åˆ†å²
                    if (orderType === 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ' || !this.isManualMode) {
                        customer.status = 'WaitCook'; // è‡ªå‹•ã§èª¿ç†å¾…ã¡
                        this.cookQueue.push({ customer: customer });
                        terop(`${numPeople}äººçµ„ï¼ˆ${orderType}æ³¨æ–‡ï¼‰ãŒæ¥åº—ã—ã€å¸­ ${customer.seatId} ã«ç€å¸­ã€‚æ³¨æ–‡: ${customer.orderedItem.name}`);
                    } else if (orderType === 'æ‰‹å‹•' && this.isManualMode) {
                        customer.status = 'WaitConfirmation'; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ³¨æ–‡ç¢ºèªã‚’å¾…ã¤
                        terop(`${numPeople}äººçµ„ï¼ˆæ‰‹å‹•æ³¨æ–‡ï¼‰ãŒæ¥åº—ã—ã€å¸­ ${customer.seatId} ã«ç€å¸­ã€‚æ³¨æ–‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    }
                    
                    this.customerSpawnInterval = Math.random() * 10 + 5;
                }
            }
        }

        removeCustomer(customer, seatId, paid) {
            const seat = this.seatsData.find(s => s.id === seatId);
            if (seat) {
                seat.isOccupied = false;
                seat.numGuests = 0;
                seat.customerId = null;
            }
            // è©²å½“ã™ã‚‹å®¢ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            this.customers = this.customers.filter(c => c.id !== customer.id);
            
            // æ€’ã£ã¦å¸°ã£ãŸå®¢ã®ã‚¿ã‚¹ã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            this.cookQueue = this.cookQueue.filter(q => q.customer.id !== customer.id);
            this.employeeTasks = this.employeeTasks.filter(t => t.customer.id !== customer.id);

            // è³‡ç”£æ›´æ–°ã¯ã€æ‰‹å‹•ä¼šè¨ˆæˆåŠŸæ™‚ã‹ã€è‡ªå‹•ä¼šè¨ˆæ™‚ã€ã¾ãŸã¯æ€’ã£ã¦å¸°ã£ãŸæ™‚ã®ã¿è¡Œã†
            if (paid) {
                // ä¼šè¨ˆæˆåŠŸ
                const profit = customer.billAmount - customer.totalCost;
                this.asset += profit;
                terop(`å¸­ ${seatId} ã®ä¼šè¨ˆå®Œäº†ï¼ æ³¨æ–‡: ${customer.orderedItem.name} x ${customer.numPeople}ã€åˆ©ç›Š: +${profit.toLocaleString()}å††`);
            } else {
                // æ€’ã£ã¦å¸°ã‚‹/å–å¼•ä¸­æ­¢
                this.asset -= customer.totalCost;
                this.reputation = Math.max(1, this.reputation - 0.1);
                terop(`å¸­ ${seatId} ã®ãŠå®¢æ§˜ãŒæ€’ã£ã¦å¸°ã‚Šã¾ã—ãŸ...è©•åˆ¤ä½ä¸‹ & æå¤±: ${customer.totalCost.toLocaleString()}å††`);
            }
        }

        // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ³¨æ–‡ç¢ºèªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        manualConfirmOrder(customerId) {
            const customer = this.customers.find(c => c.id === customerId);
            if (!customer || customer.status !== 'WaitConfirmation') return;

            // æ³¨æ–‡å†…å®¹ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
            customer.status = 'WaitCook';
            this.cookQueue.push({ customer: customer });
            terop(`å¸­ ${customer.seatId} ã®æ³¨æ–‡ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚èª¿ç†å¾…ã¡ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼`);
            this.updateDisplay();
        }

        // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¼šè¨ˆé–‹å§‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        manualInitiatePayment(customerId) {
            const customer = this.customers.find(c => c.id === customerId);
            if (!customer || customer.status !== 'WaitPayment') return;

            // ãƒ¬ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            openRegisterModal(customer);
        }

        // --- å¾“æ¥­å“¡ã‚¿ã‚¹ã‚¯å‡¦ç† ---
        processEmployeeTasks(deltaTime) {
            // 1. æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã®å‰²ã‚Šå½“ã¦ (èª¿ç†ã‚¿ã‚¹ã‚¯ã®ã¿)
            const availableEmployees = this.employees.filter(e => !this.employeeTasks.some(t => t.employeeId === e.id));
            if (this.cookQueue.length > 0 && availableEmployees.length > 0) {
                const employee = availableEmployees[0];
                const task = this.cookQueue.shift();
                
                // èª¿ç†æ™‚é–“: åŸºæœ¬10ç§’
                const baseTime = 10;
                const processTime = employee.getProcessTime(baseTime);
                
                this.employeeTasks.push({
                    type: 'Cooking',
                    employeeId: employee.id,
                    customer: task.customer,
                    timeRemaining: processTime
                });
                terop(`${employee.grade}ãŒå¸­ ${task.customer.seatId} ã®æ³¨æ–‡ (${task.customer.orderedItem.name}) ã®èª¿ç†ã‚’é–‹å§‹ (æ®‹ã‚Š ${processTime.toFixed(1)}s)`);
                task.customer.status = 'WaitServe';
            }

            // 2. å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã®æ›´æ–°
            this.employeeTasks.forEach(task => {
                task.timeRemaining -= deltaTime;
                if (task.timeRemaining <= 0) {
                    // ã‚¿ã‚¹ã‚¯å®Œäº†
                    if (task.type === 'Cooking') {
                        // èª¿ç†å®Œäº†: é£Ÿäº‹é–‹å§‹
                        task.customer.status = 'Eating';
                        terop(`å¸­ ${task.customer.seatId} ã®æ³¨æ–‡ (${task.customer.orderedItem.name}) ã®æä¾›å®Œäº†ã€‚é£Ÿäº‹é–‹å§‹ï¼`);
                    }
                    // ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                    this.employeeTasks = this.employeeTasks.filter(t => t !== task);
                }
            });
        }

        // --- æ—¥æ¬¡å‡¦ç† ---
        endOfDay() {
            this.isPaused = true;
            terop(`Day ${this.day} çµ‚äº†ï¼çµæœç™ºè¡¨...`, 10000);

            let dailyProfit = 0;
            let dailyExpense = 0;

            // 1. é–‰åº—æ™‚ç‚¹ã§æ®‹ã£ã¦ã„ã‚‹å®¢ã¯æ€’ã£ã¦å¸°ã‚‹
            this.customers.forEach(customer => {
                // æ”¯æ‰•ã„å®Œäº†ã—ã¦ã„ãªã„å®¢ã¯æå¤±
                if (customer.status !== 'Done') {
                     this.removeCustomer(customer, customer.seatId, false);
                }
            });

            // 2. äººä»¶è²»ã®è¨ˆç®—ã¨æ”¯æ‰•ã„
            this.employees.forEach(e => {
                dailyExpense += e.dailyCost;
            });

            // 3. è³‡ç”£ã®æ›´æ–°
            this.asset -= dailyExpense;
            
            // 4. è©•åˆ¤ã®æ›´æ–°
            if (this.asset > 15000000) { 
                this.reputation = Math.min(5, this.reputation + 0.1);
            } else {
                this.reputation = Math.max(1, this.reputation - 0.1);
            }


            setTimeout(() => {
                this.day++;
                this.time = 0;
                this.isPaused = false;
                
                // å¸­ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                this.seatsData.forEach(seat => {
                    seat.isOccupied = false;
                    seat.numGuests = 0;
                    seat.customerId = null;
                });
                this.customers = [];
                this.cookQueue = [];
                this.employeeTasks = [];


                terop(`Day ${this.day} ã‚¹ã‚¿ãƒ¼ãƒˆï¼ ç·äººä»¶è²»: ${dailyExpense.toLocaleString()}å††ã€‚ç¾åœ¨ã®è³‡ç”£: ${this.asset.toLocaleString()}å††`);
                this.updateDisplay();
            }, 5000); 
        }


        // --- ã‚²ãƒ¼ãƒ ã®è¡¨ç¤ºæ›´æ–° ---
        updateDisplay() {
            document.getElementById('asset-display').textContent = `è³‡ç”£: ${this.asset.toLocaleString()}å††`;
            document.getElementById('reputation-display').textContent = `è©•åˆ¤: â˜…${this.reputation.toFixed(1)}`;
            const minutes = Math.floor(this.time / 60);
            const seconds = Math.floor(this.time % 60);
            const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('time-display').textContent = timeStr;
            document.getElementById('day-display').textContent = `Day ${this.day}`;
            
            // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
            const modeText = this.isManualMode ? 'æ‰‹å‹•' : 'è‡ªå‹•';
            const btn = document.getElementById('manual-toggle-btn');
            if (btn) { // ã‚¨ãƒ©ãƒ¼é˜²æ­¢
                btn.textContent = `æ³¨æ–‡/ä¼šè¨ˆ: ${modeText}`;
                btn.style.backgroundColor = this.isManualMode ? '#ff9800' : '#4CAF50';
            }


            const seatMap = document.getElementById('seat-map');
            
            // å¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã¨ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            seatMap.innerHTML = this.seatsData.map(seat => {
                const customer = this.customers.find(c => c.id === seat.customerId);
                let className = 'seat-empty';
                let statusText = 'ç©ºå¸­';
                let onClickAction = ''; // ğŸ’¡ ä¿®æ­£: divå…¨ä½“ã«é©ç”¨ã™ã‚‹onclickãƒãƒ³ãƒ‰ãƒ©
                
                if (seat.isOccupied && customer) {
                    if (customer.status === 'WaitConfirmation') {
                        className = 'seat-occupied-confirmation';
                        statusText = `æ³¨æ–‡å¾…ã¡ï¼ˆæ‰‹å‹•ï¼‰<br>P:${customer.patience.toFixed(1)}<br>ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡ç¢ºèª`;
                        // ğŸ’¡ ä¿®æ­£: divå…¨ä½“ã‚’ã‚¿ãƒƒãƒ—å¯èƒ½ã«ã™ã‚‹
                        onClickAction = `onclick="showDialogue(game.customers.find(c => c.id === '${customer.id}'), 'OrderAsk')" style="cursor: pointer;"`;
                    } else if (customer.status === 'WaitPayment') {
                        className = 'seat-occupied-payment';
                        statusText = `ä¼šè¨ˆå¾…ã¡<br>P:${customer.patience.toFixed(1)}<br>ã‚¿ãƒƒãƒ—ã—ã¦ä¼šè¨ˆé–‹å§‹`;
                        // ğŸ’¡ ä¿®æ­£: divå…¨ä½“ã‚’ã‚¿ãƒƒãƒ—å¯èƒ½ã«ã™ã‚‹
                        onClickAction = `onclick="showDialogue(game.customers.find(c => c.id === '${customer.id}'), 'PaymentAsk')" style="cursor: pointer;"`;
                    } else if (customer.status === 'WaitOrder' || customer.status === 'WaitCook' || customer.status === 'WaitServe') {
                        className = 'seat-occupied-wait';
                        statusText = `${customer.status === 'WaitOrder' ? 'ç€å¸­' : customer.status === 'WaitCook' ? 'èª¿ç†å¾…ã¡' : 'æä¾›å¾…ã¡'}<br>P:${customer.patience.toFixed(1)}`;
                    } else if (customer.status === 'Eating') {
                        className = 'seat-occupied-eat';
                        statusText = `é£Ÿäº‹ä¸­<br>æ®‹ã‚Š:${customer.mealTimeLeft.toFixed(1)}s`;
                    } else if (customer.status === 'Paying') {
                        className = 'seat-occupied-payment';
                        statusText = `ä¼šè¨ˆå‡¦ç†ä¸­`; // è‡ªå‹•ä¼šè¨ˆç”¨
                    }
                    statusText = `${seat.numGuests}äººçµ„ (${statusText})<br>å“: ${customer.orderedItem ? customer.orderedItem.name : 'ä¸æ˜'}`;
                }
                
                return `
                    <div class="${className}" data-seat-id="${seat.id}" ${onClickAction}>
                        å¸­ ${seat.id} (${seat.isOccupied ? seat.numGuests : 0}äºº)
                        <br>
                        ${statusText}
                    </div>
                `;
            }).join('');
            
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å¾…æ©Ÿã‚¿ã‚¹ã‚¯æ•°æ›´æ–°
            document.getElementById('wait-cook-count').textContent = this.cookQueue.length;
            document.getElementById('wait-confirm-count').textContent = this.customers.filter(c => c.status === 'WaitConfirmation').length; // è¿½åŠ 
            
            // å¾“æ¥­å“¡æƒ…å ±æ›´æ–°
            document.getElementById('employee-count').textContent = this.employees.length;
            const employeeStatus = document.getElementById('employee-status');
            employeeStatus.innerHTML = this.employees.map(e => {
                const task = this.employeeTasks.find(t => t.employeeId === e.id);
                let status = 'å¾…æ©Ÿä¸­';
                if (task) {
                    status = `èª¿ç†ä¸­ (${task.customer.orderedItem.name} @ å¸­${task.customer.seatId}) - ${task.timeRemaining.toFixed(1)}s`;
                }
                return `<p style="font-size: 0.9em; margin: 5px 0;"><strong>${e.grade}</strong> (æ—¥å½“: ${e.dailyCost.toLocaleString()}å††): ${status}</p>`;
            }).join('');


            // å®¢ã®è©³ç´°æ›´æ–°
            const waitingCustomers = this.customers.filter(c => ['WaitConfirmation', 'WaitCook', 'WaitServe', 'WaitPayment'].includes(c.status));
            let waitingDetails = '';
            waitingCustomers.forEach(c => {
                const statusText = c.status === 'WaitConfirmation' ? 'æ³¨æ–‡ç¢ºèªå¾…ã¡' : 
                                   c.status === 'WaitCook' ? 'èª¿ç†å¾…ã¡' : 
                                   c.status === 'WaitServe' ? 'æä¾›å¾…ã¡' :
                                   c.status === 'WaitPayment' ? 'ä¼šè¨ˆå¾…ã¡' : 'ä¸æ˜';
                const item = c.orderedItem ? c.orderedItem.name : 'ä¸æ˜';
                waitingDetails += `<p style="margin: 5px 0; font-size: 0.9em; border-bottom: 1px dotted #eee;"> å¸­${c.seatId} (${c.numPeople}äºº) - ${statusText} <br> å“: ${item} x ${c.numPeople} (${c.billAmount.toLocaleString()}å††) </p>`;
            });
            document.getElementById('waiting-customer-details').innerHTML = waitingDetails || '<p>å¾…ã¡å®¢ãªã—</p>'; // settings modal è¡¨ç¤ºç”¨å¸­æ•°æ›´æ–°
            
            const seatsDisplay = document.getElementById('in-game-seats-display');
            if (seatsDisplay) seatsDisplay.textContent = this.currentSeats;

            document.getElementById('garbage-can-status').textContent = this.hasGarbageCan ? 'è³¼å…¥æ¸ˆã¿' : 'æœªè³¼å…¥';
        }

        // --- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾— ---
        getGameData() {
            return {
                asset: this.asset,
                reputation: this.reputation,
                day: this.day,
                time: this.time,
                storeType: this.storeType,
                location: this.location,
                currentSeats: this.currentSeats,
                
                // ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãã®ã¾ã¾ä¿å­˜ã›ãšã€å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
                employees: this.employees.map(e => ({ grade: e.grade, id: e.id })), 
                menu: this.menu.map(m => ({ name: m.name, currentPrice: m.currentPrice, cost: m.cost })),
                
                hasGarbageCan: this.hasGarbageCan,
                isInfiniteAsset: isInfiniteAsset, // ãƒãƒ¼ãƒˆè¨­å®šã‚‚ä¿å­˜
                isManualMode: this.isManualMode // ã€è¿½åŠ ã€‘ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚‚ä¿å­˜
            };
        }
        
        // --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®é©ç”¨ ---
        applyGameData(data) {
            this.asset = data.asset;
            this.reputation = data.reputation;
            this.day = data.day;
            this.time = data.time;
            this.storeType = data.storeType;
            this.location = data.location;
            this.currentSeats = data.currentSeats;

            // å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ (Employeeã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–)
            this.employees = data.employees.map(e => new Employee(e.grade, e.id));
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ (MenuItemã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–)
            this.menu = data.menu.map(m => new MenuItem(m.name, m.currentPrice, m.cost));
            
            // ãã®ä»–è¨­å®š
            this.hasGarbageCan = data.hasGarbageCan || false;
            isInfiniteAsset = data.isInfiniteAsset || false;
            this.isManualMode = data.isManualMode !== undefined ? data.isManualMode : true; 
            
            // ç„¡åˆ¶é™ãƒãƒ¼ãƒˆã®UIåæ˜ 
            const toggle = document.getElementById('infinite-asset-toggle');
            if (toggle) toggle.checked = isInfiniteAsset;

            // å¸­ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ– (å®¢ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹)
            this.seatsData = [];
            for (let i = 0; i < this.currentSeats / 2; i++) {
                this.seatsData.push({ id: i + 1, isOccupied: false, numGuests: 0, customerId: null });
            }

            // ã‚²ãƒ¼ãƒ ç”»é¢ã®åˆæœŸåŒ–è¨­å®šã‚’æ›´æ–°
            this.initializeGame({
                type: this.storeType,
                location: this.location,
                currentSeats: this.currentSeats,
                initialMenu: this.menu 
            });

            this.updateDisplay();
        }
    }


    // =========================================================
    // 2. ç”»é¢ã¨åˆæœŸè¨­å®šãƒ­ã‚¸ãƒƒã‚¯
    // =========================================================

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(id).classList.add('active');
        if (id === 'game-screen') {
            document.body.classList.remove('mobile-mode');
        }
    }

    function selectType(type) {
        currentSettings.type = type;
        const info = type === 'FastFood' ? 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰åº—ã¯å®¢å˜ä¾¡ã¯ä½ã„ãŒå›è»¢ç‡ãŒé«˜ã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚' : 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¯å®¢å˜ä¾¡ã¯é«˜ã„ãŒå›è»¢ç‡ãŒä½ã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚';
        document.getElementById('type-info').textContent = info;
        document.getElementById('step-location').style.display = 'block';
    }

    function selectLocation(location, maxSeats) {
        currentSettings.location = location;
        currentSettings.maxSeats = maxSeats;
        const cost = costDetails[location] + costDetails['BASE'];
        currentSettings.initialCost = cost;
        document.getElementById('location-info').textContent = `${location}ã‚’é¸æŠã€‚åˆæœŸè²»ç”¨: ${cost.toLocaleString()}å††ã€‚æœ€å¤§å¸­æ•°: ${maxSeats}å¸­ã€‚`;
        document.getElementById('max-seats').textContent = maxSeats;
        document.getElementById('step-size').style.display = 'block';
        
        // å¸­æ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®2å¸­ã«è¨­å®š
        currentSettings.currentSeats = 2;
        updateSeatSizeDisplay();
        document.getElementById('step-menu').style.display = 'block';
        updateMenuSelectionUI();
    }

    function changeSeats(delta) {
        let newSeats = currentSettings.currentSeats + delta;
        if (newSeats < 2) newSeats = 2;
        if (newSeats > currentSettings.maxSeats) newSeats = currentSettings.maxSeats;
        if (newSeats > GLOBAL_MAX_SEATS) newSeats = GLOBAL_MAX_SEATS; // å…¨ä½“ã®ä¸Šé™
        
        currentSettings.currentSeats = newSeats;
        updateSeatSizeDisplay();
    }

    function updateSeatSizeDisplay() {
        const tableCount = currentSettings.currentSeats / 2;
        const totalCost = calculateInitialCost(currentSettings.currentSeats, currentSettings.location);
        
        document.getElementById('current-seats').textContent = currentSettings.currentSeats;
        document.getElementById('current-tables').textContent = tableCount;
        document.getElementById('initial-cost').textContent = totalCost.toLocaleString();
        currentSettings.initialCost = totalCost;
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
        document.getElementById('step-menu').style.display = 'block';
        document.getElementById('step-start').style.display = 'block';
    }

    function calculateInitialCost(seats, location) {
        const base = costDetails[location] || 0;
        const seatCost = 500000; // 1ãƒ†ãƒ¼ãƒ–ãƒ«(2å¸­)ã‚ãŸã‚Šã®åˆæœŸè²»ç”¨
        const totalSeatCost = (seats / 2) * seatCost;
        return base + totalSeatCost;
    }

    function toggleMenuSelection(menuName) {
        const menuData = MENU_DATA[currentSettings.type].find(m => m.name === menuName);
        if (!menuData) return;

        const isSelected = currentSettings.initialMenu.some(m => m.name === menuName);
        
        if (isSelected) {
            currentSettings.initialMenu = currentSettings.initialMenu.filter(m => m.name !== menuName);
        } else {
            if (currentSettings.initialMenu.length < 5) {
                currentSettings.initialMenu.push(menuData);
            } else {
                terop('åˆæœŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯5å€‹ã¾ã§ã—ã‹é¸ã¹ã¾ã›ã‚“ã€‚');
                return;
            }
        }
        updateMenuSelectionUI();
    }

    function updateMenuSelectionUI() {
        const menuArea = document.getElementById('menu-selection-area');
        if (!menuArea) return;

        // ãƒœã‚¿ãƒ³ã®å†æç”»
        menuArea.innerHTML = MENU_DATA[currentSettings.type].map(menu => {
            const isSelected = currentSettings.initialMenu.some(m => m.name === menu.name);
            const bgColor = isSelected ? '#4CAF50' : '#2196F3';
            return `<button 
                        style="background-color: ${bgColor};" 
                        onclick="toggleMenuSelection('${menu.name}')">
                        ${menu.name} (${menu.basePrice}å††)
                    </button>`;
        }).join('');
        
        document.getElementById('selected-menu-count').textContent = currentSettings.initialMenu.length;
    }


    function showConfirmation() {
        if (!currentSettings.type || !currentSettings.location || currentSettings.currentSeats === 0 || currentSettings.initialMenu.length === 0) {
            terop('è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚åº—ç¨®åˆ¥ã€å ´æ‰€ã€å¸­æ•°ã€åˆæœŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const summaryDiv = document.getElementById('config-summary');
        const menuList = currentSettings.initialMenu.map(m => `${m.name} (${m.basePrice.toLocaleString()}å††)`).join(', ');
        
        summaryDiv.innerHTML = `
            <p><strong>åº—ç¨®åˆ¥:</strong> ${currentSettings.type}</p>
            <p><strong>å ´æ‰€:</strong> ${currentSettings.location}</p>
            <p><strong>å¸­æ•°:</strong> ${currentSettings.currentSeats} å¸­</p>
            <p><strong>åˆæœŸè²»ç”¨:</strong> ${currentSettings.initialCost.toLocaleString()} å††</p>
            <p><strong>åˆæœŸãƒ¡ãƒ‹ãƒ¥ãƒ¼:</strong> ${menuList}</p>
        `;
        showScreen('confirmation-screen');
    }

    function resetSetup() {
        currentSettings = { type: null, location: null, maxSeats: 0, currentSeats: 0, initialCost: 0, initialMenu: [] };
        // UIãƒªã‚»ãƒƒãƒˆ
        document.getElementById('type-info').textContent = '';
        document.getElementById('location-info').textContent = '';
        document.getElementById('current-seats').textContent = '0';
        document.getElementById('current-tables').textContent = '0';
        document.getElementById('initial-cost').textContent = '0';
        document.getElementById('menu-selection-area').innerHTML = '';
        document.getElementById('selected-menu-count').textContent = '0';

        document.getElementById('step-location').style.display = 'none';
        document.getElementById('step-size').style.display = 'none';
        document.getElementById('step-menu').style.display = 'none';
        document.getElementById('step-start').style.display = 'none';

        showScreen('start-screen');
    }

    // =========================================================
    // 3. ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨æ“ä½œ
    // =========================================================

    let lastTime = 0;

    function gameLoop(timestamp) {
        if (!game.isGameRunning) return;

        const deltaTime = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        game.update(deltaTime);
        
        // ç„¡åˆ¶é™ãƒãƒ¼ãƒˆãŒONã®å ´åˆã¯è³‡ç”£ã‚’å¸¸ã«ä¸€å®šé¡ä»¥ä¸Šã«ä¿ã¤
        if (isInfiniteAsset) {
            game.asset = Math.max(game.asset, 999999999);
        }

        gameLoopRef = requestAnimationFrame(gameLoop);
    }

    function startGame() {
        if (currentSettings.initialMenu.length === 0) {
            terop('åˆæœŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
            return;
        }

        // è³‡ç”£ãƒã‚§ãƒƒã‚¯ã¨æ”¯æ‰•ã„
        if (game.asset < currentSettings.initialCost && !isInfiniteAsset) {
            terop(`åˆæœŸè²»ç”¨(${currentSettings.initialCost.toLocaleString()}å††)ãŒè¶³ã‚Šã¾ã›ã‚“ï¼`);
            return;
        }
        
        if (!isInfiniteAsset) {
            game.asset -= currentSettings.initialCost;
        }

        game.initializeGame(currentSettings);
        showScreen('game-screen');
        lastTime = performance.now();
        gameLoopRef = requestAnimationFrame(gameLoop);
        terop('ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼');
    }

    function quitGame() {
        if (confirm('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿã‚»ãƒ¼ãƒ–ã—ã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ã€‚')) {
            showScreen('home-screen');
            game.isGameRunning = false;
            if (gameLoopRef) cancelAnimationFrame(gameLoopRef);
            game.resetGame();
            resetSetup(); // åˆæœŸè¨­å®šã‚‚ãƒªã‚»ãƒƒãƒˆ
        }
    }

    // --- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ ---

    function saveGame() {
        try {
            const data = game.getGameData();
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
            terop('ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼');
        } catch (e) {
            terop('ã‚»ãƒ¼ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 5);
            console.error(e);
        }
    }

    function loadGameData(data) {
        try {
            // ã‚²ãƒ¼ãƒ è¨­å®šã‚’ã‚¯ãƒªã‚¢
            game.resetGame();
            // ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
            game.applyGameData(data);
            
            // UIã‚’ã‚²ãƒ¼ãƒ ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆã€ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
            showScreen('game-screen');
            game.isGameRunning = true;
            game.isPaused = false;
            lastTime = performance.now();
            if (gameLoopRef) cancelAnimationFrame(gameLoopRef);
            gameLoopRef = requestAnimationFrame(gameLoop);

            terop('ã‚²ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        } catch (e) {
            terop('ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 5);
            console.error(e);
        }
    }

    function loadGameFromHome() {
        const savedData = localStorage.getItem(SAVE_KEY);
        if (savedData) {
            const data = JSON.parse(savedData);
            loadGameData(data);
        } else {
            terop('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
    }
    
    function checkSavedGame() {
        const savedData = localStorage.getItem(SAVE_KEY);
        const loadBtn = document.getElementById('load-game-btn');
        const loadInfo = document.getElementById('load-info');
        if (savedData) {
            loadBtn.style.display = 'inline-block';
            loadInfo.textContent = 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚';
        } else {
            loadBtn.style.display = 'none';
            loadInfo.textContent = 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        }
    }

    // è‡ªå‹•/æ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    function toggleManualMode() {
        game.isManualMode = !game.isManualMode;
        
        // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«ã€é€²è¡Œä¸­ã®å®¢ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå¼·åˆ¶çš„ã«æ¬¡ã¸é€²ã‚ã‚‹ï¼‰
        game.customers.forEach(customer => {
            if (customer.status === 'WaitConfirmation' || customer.status === 'WaitPayment') {
                if (!game.isManualMode) {
                    // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã¸: æ³¨æ–‡/ä¼šè¨ˆã‚’è‡ªå‹•ã§å®Œäº†ã•ã›ã‚‹
                    if (customer.status === 'WaitConfirmation') {
                        game.manualConfirmOrder(customer.id); // æ³¨æ–‡ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
                    } else if (customer.status === 'WaitPayment') {
                        customer.status = 'Paying'; // è‡ªå‹•ä¼šè¨ˆã¸ç§»è¡Œ
                    }
                } else {
                     // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã¸: æ³¨æ–‡å¾…ã¡ã®å ´åˆã¯ãã®ã¾ã¾ã€æ”¯æ‰•ã„å¾…ã¡ã®å ´åˆã¯å¾…æ©Ÿç¶™ç¶š
                     if (customer.status === 'Paying') {
                         customer.status = 'WaitPayment'; // Payingã‹ã‚‰WaitPaymentã«æˆ»ã™
                     }
                }
            }
        });

        terop(`æ³¨æ–‡/ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã‚’${game.isManualMode ? 'æ‰‹å‹•' : 'è‡ªå‹•'}ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`);
        game.updateDisplay();
    }


    // =========================================================
    // 4. ä¼šè©±ãƒ†ãƒ­ãƒƒãƒ—ã¨ãƒ¬ã‚¸æ“ä½œãƒ­ã‚¸ãƒƒã‚¯
    // =========================================================

    // --- ä¼šè©±ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤º ---
    function showDialogue(customer, type) {
        // ã€ä¿®æ­£ç‚¹ã€‘å…¥åŠ›ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
        game.isPaused = true; 

        const dialogueBox = document.getElementById('customer-dialogue-box');
        const dialogueText = document.getElementById('dialogue-text');
        const dialogueOptions = document.getElementById('dialogue-options');
        const dialogueImg = document.getElementById('dialogue-img');
        const dialogueSpeaker = document.getElementById('dialogue-speaker');

        dialogueImg.src = CUSTOMER_IMAGE_URL;
        dialogueSpeaker.textContent = `å¸­ ${customer.seatId} ã®ãŠå®¢æ§˜`;
        dialogueOptions.innerHTML = '';

        if (type === 'OrderAsk') {
            dialogueText.innerHTML = `ã€Œã™ã¿ã¾ã›ã‚“ã€æ³¨æ–‡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚<br>ãˆãƒ¼ã¨ã€**${customer.orderedItem.name}ã‚’${customer.numPeople}ã¤**ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€`;
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'OK (æ³¨æ–‡ç¢ºèª)';
            confirmBtn.onclick = () => {
                game.manualConfirmOrder(customer.id);
                closeDialogue();
            };
            dialogueOptions.appendChild(confirmBtn);
        } else if (type === 'PaymentAsk') {
            dialogueText.innerHTML = `ã€Œã”ã¡ãã†ã•ã¾ã§ã—ãŸã€‚ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€<br>è«‹æ±‚é¡: **${customer.billAmount.toLocaleString()}å††**`;
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'OK (ãƒ¬ã‚¸ã‚’é–‹ã)';
            confirmBtn.onclick = () => {
                game.manualInitiatePayment(customer.id);
                closeDialogue(true); // ãƒ¬ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãã®ã§ã€ä¸€æ™‚åœæ­¢è§£é™¤ã¯ã—ãªã„
            };
            dialogueOptions.appendChild(confirmBtn);
        } else if (type === 'PaymentComplete') {
             dialogueText.innerHTML = `ã€ŒãŠé‡£ã‚Š**${currentTransaction.changeGiven.toLocaleString()}å††**ã€ç¢ºã‹ã«å—ã‘å–ã‚Šã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ï¼ã€`;
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'OK (å–å¼•å®Œäº†)';
            closeBtn.onclick = () => {
                const finishedCustomer = game.customers.find(c => c.id === currentTransaction.customerId);
                if (finishedCustomer) {
                    // ã€ä¿®æ­£ç‚¹ã€‘ã“ã“ã§ç›´æ¥å®¢ã‚’è§£æ”¾ã—ã€æ”¯æ‰•æ¸ˆã¿ã®ãƒ•ãƒ©ã‚°(true)ã‚’æ¸¡ã™
                    game.removeCustomer(finishedCustomer, finishedCustomer.seatId, true); 
                }
                closeDialogue(); 
            };
            dialogueOptions.appendChild(closeBtn);
        }

        dialogueBox.style.display = 'block';
    }

    // --- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ ---
    function closeDialogue(keepPaused = false) {
        const dialog = document.getElementById('customer-dialogue-box');
        dialog.style.display = 'none';

        if (!keepPaused) {
            // ä¸€æ™‚çš„ã«ãƒ­ãƒƒã‚¯ã—ã¦å‡¦ç†ä¸­ã®é‡è¤‡ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²æ­¢
            isInputLocked = true;
            console.log("closeDialogue: å…¥åŠ›ãƒ­ãƒƒã‚¯é–‹å§‹");

            // UIæ›´æ–° â†’ ã‚²ãƒ¼ãƒ å†é–‹ â†’ ãƒ­ãƒƒã‚¯è§£é™¤ ã®é †ç•ª
            setTimeout(() => {
                game.updateDisplay(); Â // UIã‚’å…ˆã«æ›´æ–°
                game.isPaused = false; // ã‚²ãƒ¼ãƒ å†é–‹
                isInputLocked = false; // ãƒ­ãƒƒã‚¯è§£é™¤
                console.log("closeDialogue: UIæ›´æ–° â†’ ã‚²ãƒ¼ãƒ å†é–‹ â†’ ãƒ­ãƒƒã‚¯è§£é™¤å®Œäº†");
            }, 50); // é…å»¶ã¯50msã§ååˆ†
        } else {
            console.log("closeDialogue: ä¸€æ™‚åœæ­¢ç¶™ç¶š (keepPaused = true)");
        }
    }

    // --- ãƒ¬ã‚¸æ“ä½œ ---
    function openRegisterModal(customer) {
        game.isPaused = true; 
        document.getElementById('register-modal').style.display = 'block';

        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’åˆæœŸåŒ–
        currentTransaction.customerId = customer.id;
        currentTransaction.billAmount = customer.billAmount;
        currentTransaction.receivedAmount = 0;
        currentTransaction.changeGiven = 0;
        currentTransaction.changeDispensed = {};
        
        // ã€ä¿®æ­£ç‚¹ã€‘å®¢ãŒæ¸¡ã™é‡‘é¡ã‚’æ±ºå®šã—ã€ãŠé‡£ã‚ŠãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
        const bill = customer.billAmount;
        const availableBills = [10000, 5000, 1000];
        let received = bill;

        // è«‹æ±‚é¡ã‚ˆã‚Šå¤§ãã„æœ€å°ã®ç´™å¹£é¡ã‚’é¸ã¶
        for (const cash of availableBills) {
            if (cash > bill) {
                received = cash;
                break;
            }
        }

        // è«‹æ±‚é¡ãŒ10000å††ä»¥ä¸Šã§ã€receivedãŒbillã¨åŒã˜ã¾ã¾ã®å ´åˆï¼ˆç´™å¹£ã§è³„ãˆãªã„å ´åˆï¼‰
        if (received === bill) {
            // 1000å††å˜ä½ã§åˆ‡ã‚Šä¸Šã’ã¦ã€ã•ã‚‰ã«1000å††ã‚’ä¸Šä¹—ã›ã™ã‚‹
            received = Math.ceil(bill / 1000) * 1000 + 1000;
        }

        // UIã‚’åˆæœŸåŒ–
        document.getElementById('bill-amount-display').textContent = customer.billAmount.toLocaleString();
        document.getElementById('received-amount-input').value = received; // æ±ºå®šã—ãŸé‡‘é¡ã‚’ã‚»ãƒƒãƒˆ
        currentTransaction.receivedAmount = received; // åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
        updateRegisterDisplay();
        
        // ã‚³ã‚¤ãƒ³ãƒˆãƒ¬ã‚¤ã®ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
        const coinTray = document.getElementById('coin-change-tray');
        coinTray.innerHTML = '';
        currentTransaction.changeCoins.forEach(coin => {
            const button = document.createElement('button');
            const coinText = coin >= 1000 ? `${coin / 1000}åƒ` : coin;
            button.textContent = `Â¥${coinText}`;
            button.onclick = () => addChange(coin);
            coinTray.appendChild(button);
        });
    }

    function updateRegisterDisplay() {
        const inputElement = document.getElementById('received-amount-input');
        // æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤
        inputElement.value = inputElement.value.replace(/[^0-9]/g, '');
        
        const inputAmount = parseInt(inputElement.value) || 0;
        
        currentTransaction.receivedAmount = inputAmount;
        const changeDue = currentTransaction.receivedAmount - currentTransaction.billAmount;
        const changeDueDisplay = document.getElementById('change-due-display');
        const receivedTotalDisplay = document.getElementById('received-total-display');
        const registerTotal = document.getElementById('register-total');
        const registerReceived = document.getElementById('register-received');
        const registerMessage = document.getElementById('register-message');

        receivedTotalDisplay.textContent = currentTransaction.receivedAmount.toLocaleString();
        registerReceived.textContent = `å—å–é¡: Â¥${currentTransaction.receivedAmount.toLocaleString()}`;
        registerTotal.textContent = `åˆè¨ˆ: Â¥${currentTransaction.billAmount.toLocaleString()}`;

        if (changeDue < 0) {
            changeDueDisplay.textContent = 'ä¸è¶³ï¼';
            changeDueDisplay.style.color = 'red';
            registerMessage.textContent = 'å®¢ã®æ”¯æ‰•ã„é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚';
        } else if (changeDue === 0) {
            changeDueDisplay.textContent = '0';
            changeDueDisplay.style.color = 'yellow';
            registerMessage.textContent = 'ã´ã£ãŸã‚Šã§ã™ã€‚ãŠé‡£ã‚Šã¯ä¸è¦ã§ã™ã€‚';
        } else {
            changeDueDisplay.textContent = changeDue.toLocaleString();
            changeDueDisplay.style.color = 'yellow';
            registerMessage.textContent = '';
        }

        // æ¸¡ã—ãŸãŠé‡£ã‚Šåˆè¨ˆã®è¡¨ç¤º
        const changeGivenDisplay = document.getElementById('change-given-display');
        changeGivenDisplay.textContent = currentTransaction.changeGiven.toLocaleString();
    }

    function addChange(coinValue) {
        currentTransaction.changeGiven += coinValue;
        currentTransaction.changeDispensed[coinValue] = (currentTransaction.changeDispensed[coinValue] || 0) + 1;
        updateRegisterDisplay();
    }

    function giveChange() {
        const changeDue = currentTransaction.receivedAmount - currentTransaction.billAmount;

        if (changeDue < 0) {
            terop('ä¼šè¨ˆå¤±æ•—: å®¢ã®æ”¯æ‰•ã„é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å–å¼•ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚');
            closeModal('register-modal');
            return;
        }

        if (currentTransaction.changeGiven === changeDue) {
            // å–å¼•æˆåŠŸ
            const customer = game.customers.find(c => c.id === currentTransaction.customerId);
            if (!customer) {
                 terop('ä¼šè¨ˆå¤±æ•—: ãŠå®¢æ§˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                 closeModal('register-modal');
                 return;
            }
            
            // è«‹æ±‚é¡ã¨åŸä¾¡ã‚’å…ƒã«åˆ©ç›Šã‚’è¨ˆç®—ã—ã€è³‡ç”£ã‚’æ›´æ–°
            // åˆ©ç›Šã®è¨ˆç®—ã¨è³‡ç”£ã®æ›´æ–°ã¯removeCustomerå†…ã§è¡Œã‚ã‚Œã‚‹
            
            // ã€ä¿®æ­£ã€‘å®¢ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’Payingã«å¤‰æ›´ã—ã€ä¼šè©±çµ‚äº†ã¾ã§å¸­ã‚’è§£æ”¾ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            customer.status = 'Paying'; 
            
            // ä¼šè¨ˆå¾Œã®å®¢ã®ä¼šè©±ã‚’è¡¨ç¤ºã—ã€ãƒ¬ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeModal('register-modal', true); // ãƒ¬ã‚¸ã‚’é–‰ã˜ã‚‹ãŒã€ä¸€æ™‚åœæ­¢ã¯ç¶™ç¶š
            showDialogue(customer, 'PaymentComplete'); 
            
            // removeCustomerã¯PaymentCompleteã®OKãƒœã‚¿ãƒ³ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯teropã®ã¿

        } else {
            // ãŠé‡£ã‚ŠãŒé–“é•ã£ã¦ã„ã‚‹
            document.getElementById('register-message').textContent = `ãŠé‡£ã‚ŠãŒ**${changeDue.toLocaleString()}å††**ã«å¯¾ã—ã€**${currentTransaction.changeGiven.toLocaleString()}å††**æ¸¡ã—ã¦ã„ã¾ã™ã€‚ãŠé‡£ã‚Šã®é‡‘é¡ãŒåˆã„ã¾ã›ã‚“ï¼`;
            terop('ãŠé‡£ã‚Šã®é‡‘é¡ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
        }
    }
    
    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ ---
    function closeModal(modalId, keepPaused = false) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';

        if (modalId === 'register-modal') {
            // ãƒ¬ã‚¸å–å¼•ã‚’ä¸­æ­¢ã—ãŸå ´åˆï¼ˆgiveChangeä»¥å¤–ã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆï¼‰
            const customer = game.customers.find(c => c.id === currentTransaction.customerId);

            if (customer && customer.status === 'WaitPayment') {
                // å–å¼•ä¸­æ­¢
                terop('ä¼šè¨ˆå–å¼•ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚');
            }
            currentTransaction.customerId = null;
            currentTransaction.changeGiven = 0;
            currentTransaction.receivedAmount = 0;
        }

        if (!keepPaused) {
            // ä¸€æ™‚çš„ã«ãƒ­ãƒƒã‚¯
            isInputLocked = true;
            console.log("closeModal: å…¥åŠ›ãƒ­ãƒƒã‚¯é–‹å§‹");

            // UIæ›´æ–° â†’ ã‚²ãƒ¼ãƒ å†é–‹ â†’ ãƒ­ãƒƒã‚¯è§£é™¤
            setTimeout(() => {
                game.updateDisplay(); Â // UIæ›´æ–°
                game.isPaused = false; // ã‚²ãƒ¼ãƒ å†é–‹
                isInputLocked = false; // ãƒ­ãƒƒã‚¯è§£é™¤
                console.log("closeModal: UIæ›´æ–° â†’ ã‚²ãƒ¼ãƒ å†é–‹ â†’ ãƒ­ãƒƒã‚¯è§£é™¤å®Œäº†");
            }, 50);
        } else {
            console.log("closeModal: ä¸€æ™‚åœæ­¢ç¶™ç¶š (keepPaused = true)");
        }
    }


    // =========================================================
    // 5. è¨­å®šãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†
    // =========================================================

    function showSettings() {
        // ã€ä¿®æ­£ç‚¹ã€‘å…¥åŠ›ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
        game.isPaused = true;
        updateEmployeeSettings();
        document.getElementById('settings-modal').style.display = 'block';
    }

    function updateEmployeeSettings() {
        const listDiv = document.getElementById('employee-list-settings');
        listDiv.innerHTML = game.employees.map(e => {
            return `
                <div class="employee-item">
                    <span>${e.grade} (æ—¥å½“: ${e.dailyCost.toLocaleString()}å††)</span>
                    <button onclick="removeEmployee('${e.id}')" style="background-color: #f44336; margin: 0;">è§£é›‡</button>
                </div>
            `;
        }).join('');
        document.getElementById('current-employee-count').textContent = game.employees.length;
    }

    function addEmployee(grade) {
        if (game.asset < 500000) { // ä»®ã®æ¡ç”¨è²»ç”¨
            terop('æ¡ç”¨è²»ç”¨ï¼ˆ50ä¸‡å††ï¼‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼');
            return;
        }
        game.asset -= 500000; // æ¡ç”¨è²»ç”¨
        game.employees.push(new Employee(grade));
        updateEmployeeSettings();
        terop(`${grade}å¾“æ¥­å“¡ã‚’é›‡ç”¨ã—ã¾ã—ãŸï¼`);
    }

    function removeEmployee(id) {
        if (game.employees.length <= 1) {
            terop('æœ€ä½ä¸€äººã¯å¾“æ¥­å“¡ãŒå¿…è¦ã§ã™ã€‚');
            return;
        }
        game.employees = game.employees.filter(e => e.id !== id);
        updateEmployeeSettings();
        terop('å¾“æ¥­å“¡ã‚’è§£é›‡ã—ã¾ã—ãŸã€‚');
    }

    function toggleInfiniteAsset() {
        isInfiniteAsset = document.getElementById('infinite-asset-toggle').checked;
        if (isInfiniteAsset) {
            game.asset = 999999999;
            terop('è³‡ç”£ç„¡åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ã‚’ONã«ã—ã¾ã—ãŸã€‚');
        } else {
            terop('è³‡ç”£ç„¡åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ã‚’OFFã«ã—ã¾ã—ãŸã€‚');
        }
    }

    function changeSeatsInGame(delta) {
        const newSeats = game.currentSeats + delta;
        if (newSeats < 2) {
            terop('å¸­æ•°ã¯æœ€ä½2å¸­å¿…è¦ã§ã™ã€‚');
            return;
        }
        if (newSeats > GLOBAL_MAX_SEATS) {
            terop(`å¸­æ•°ã¯æœ€å¤§${GLOBAL_MAX_SEATS}å¸­ã¾ã§ã§ã™ã€‚`);
            return;
        }
        
        // æ¸›ã‚‰ã™å ´åˆã€ç©ºå¸­ã§ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (delta < 0) {
            const tablesToRemove = Math.abs(delta) / 2;
            const occupiedSeatsCount = game.seatsData.filter(s => s.isOccupied).length;
            const currentTables = game.seatsData.length;
            
            if (currentTables - tablesToRemove < occupiedSeatsCount / 2) {
                terop('å®¢ãŒã„ã‚‹ãŸã‚ã€å¸­ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚');
                return;
            }
        }

        // å®Ÿè¡Œ
        const success = game.changeSeatsInGame(newSeats);
        if (success) {
            // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹è¨­å®šã«ã‚‚åæ˜ ã—ã¦ãŠã
            currentSettings.currentSeats = game.currentSeats;
        }
    }
    
    // GameManagerã« changeSeatsInGame ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ /ä¿®æ­£
    GameManager.prototype.changeSeatsInGame = function(newSeats) {
        // æ¸›ã‚‰ã™å ´åˆ
        if (newSeats < this.currentSeats) {
            const tablesToRemove = (this.currentSeats - newSeats) / 2;
            
            for (let i = 0; i < tablesToRemove; i++) {
                const lastSeatIndex = this.seatsData.length - 1;
                const seatToRemove = this.seatsData[lastSeatIndex];
                
                if (seatToRemove && seatToRemove.isOccupied) {
                    terop('å®¢ãŒã„ã‚‹ãŸã‚ã€å¸­ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚', 3);
                    return false;
                }
                this.seatsData.pop();
            }
        } 
        // å¢—ã‚„ã™å ´åˆ
        else if (newSeats > this.currentSeats) {
            const tablesToAdd = (newSeats - this.currentSeats) / 2;
            const currentTableCount = this.seatsData.length;
            
            for (let i = 0; i < tablesToAdd; i++) {
                this.seatsData.push({ id: currentTableCount + i + 1, isOccupied: false, numGuests: 0, customerId: null });
            }
        }

        this.currentSeats = newSeats;
        terop(`å¸­æ•°ã‚’${newSeats}å¸­ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
        this.updateDisplay();
        return true;
    };


    function showItems() {
        // ã€ä¿®æ­£ç‚¹ã€‘å…¥åŠ›ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
        game.isPaused = true;
        updateItemPurchaseUI();
        document.getElementById('item-modal').style.display = 'block';
    }

    function updateItemPurchaseUI() {
        const itemListDiv = document.getElementById('item-list-purchase');
        itemListDiv.innerHTML = Object.keys(ITEM_DATA).map(key => {
            const item = ITEM_DATA[key];
            const isPurchased = (key === 'GARBAGE_CAN' && game.hasGarbageCan);
            const buttonHtml = isPurchased ? 
                `<button disabled style="background-color: #ccc;">è³¼å…¥æ¸ˆã¿</button>` :
                `<button onclick="purchaseItem('${key}')" class="action-btn">è³¼å…¥</button>`;
            
            return `
                <div class="item-list-row">
                    <span><strong>${item.name}</strong> (${item.cost.toLocaleString()}å††)</span>
                    <span>${item.effect}</span>
                    ${buttonHtml}
                </div>
            `;
        }).join('');
    }

    function purchaseItem(key) {
        const item = ITEM_DATA[key];
        if (game.asset < item.cost) {
            terop('è³‡ç”£ãŒè¶³ã‚Šã¾ã›ã‚“ï¼');
            return;
        }

        game.asset -= item.cost;

        if (key === 'GARBAGE_CAN') {
            game.hasGarbageCan = true;
            terop(`${item.name}ã‚’è³¼å…¥ã—ã¾ã—ãŸã€‚å®¢ã®æº€è¶³åº¦ãŒç¶­æŒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚`);
        } else if (key === 'CLEANING') {
            game.reputation = Math.min(5, game.reputation + 0.2);
            terop(`${item.name}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚è©•åˆ¤ãŒ0.2ä¸ŠãŒã‚Šã¾ã—ãŸã€‚`);
        }

        updateItemPurchaseUI();
        game.updateDisplay();
    }


    function showMenu() {
        // ã€ä¿®æ­£ç‚¹ã€‘å…¥åŠ›ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
        game.isPaused = true;
        updateMenuSettings();
        document.getElementById('menu-modal').style.display = 'block';
    }

    function updateMenuSettings() {
        document.getElementById('menu-count').textContent = game.menu.length;
        
        const currentMenuList = document.getElementById('current-menu-list');
        currentMenuList.innerHTML = game.menu.map(item => {
            return `
                <div class="menu-item-row">
                    <span>${item.name}</span>
                    <label>
                        ä¾¡æ ¼: 
                        <input type="number" 
                                value="${item.currentPrice}" 
                                min="100" 
                                onchange="setMenuPrice('${item.name}', this.value)">
                        å††
                    </label>
                    <button onclick="removeMenuItem('${item.name}')" style="background-color: #f44336; margin: 0;">æä¾›åœæ­¢</button>
                </div>
            `;
        }).join('');
    }

    function setMenuPrice(menuName, newPrice) {
        const price = parseInt(newPrice);
        if (isNaN(price) || price < 100) {
            terop('ä¾¡æ ¼ã¯100å††ä»¥ä¸Šã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            updateMenuSettings(); // UIã‚’å…ƒã«æˆ»ã™
            return;
        }

        const item = game.menu.find(m => m.name === menuName);
        if (item) {
            item.currentPrice = price;
            terop(`${menuName}ã®ä¾¡æ ¼ã‚’${price.toLocaleString()}å††ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
        }
    }

    function removeMenuItem(menuName) {
        if (game.menu.length <= 1) {
            terop('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æœ€ä½1ã¤å¿…è¦ã§ã™ã€‚');
            return;
        }
        game.menu = game.menu.filter(m => m.name !== menuName);
        updateMenuSettings();
        terop(`${menuName}ã®æä¾›ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚`);
    }

    function showAllMenuOptions() {
        const allMenuDiv = document.getElementById('all-menu-options');
        allMenuDiv.style.display = 'block';
        
        const currentMenuNames = game.menu.map(m => m.name);
        
        allMenuDiv.innerHTML = MENU_DATA[game.storeType].filter(m => !currentMenuNames.includes(m.name)).map(menu => {
            return `<button onclick="addMenuItem('${menu.name}')" class="action-btn" style="background-color: #00bcd4; margin: 5px;">${menu.name} (${menu.basePrice}å††)</button>`;
        }).join('');

        if (allMenuDiv.innerHTML === '') {
            allMenuDiv.innerHTML = '<p>å…¨ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æä¾›ä¸­ã§ã™ã€‚</p>';
        }
    }

    function addMenuItem(menuName) {
        const menuData = MENU_DATA[game.storeType].find(m => m.name === menuName);
        if (menuData) {
            game.menu.push(new MenuItem(menuData.name, menuData.basePrice, menuData.cost));
            terop(`${menuName}ã®æä¾›ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚`);
            updateMenuSettings();
            document.getElementById('all-menu-options').style.display = 'none'; // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ å¾Œã€ä¸€è¦§ã‚’éè¡¨ç¤º
        }
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ ---

    function downloadSaveFile() {
        const data = JSON.stringify(game.getGameData(), null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'restaurant_tycoon_save.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        terop('ã‚»ãƒ¼ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
    }

    function loadGameFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                loadGameData(data);
                closeModal('settings-modal');
            } catch (error) {
                terop('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç„¡åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚');
                console.error(error);
            }
        };
        reader.readAsText(file);
    }

    // --- ãƒ¢ãƒã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
    function toggleMobileMode() {
        const isMobile = document.body.classList.toggle('mobile-mode');
        const btn = document.getElementById('mobile-toggle-btn');
        btn.textContent = isMobile ? 'PCãƒ¢ãƒ¼ãƒ‰' : 'ã‚¹ãƒãƒ›ãƒ¢ãƒ¼ãƒ‰';
        terop(isMobile ? 'ã‚¹ãƒãƒ›ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ' : 'PCãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã—ã¾ã—ãŸ');
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
    function terop(message, duration = 3000) {
        const teropElement = document.getElementById('log-terop');
        teropElement.innerHTML = message;
        teropElement.style.opacity = '1';
        setTimeout(() => {
            teropElement.style.opacity = '0';
        }, duration);
    }
    
    function getUrlParameter(name) {
        name = name.replace(/[\\[]/, '\\\\[').replace(/[\\]]/, '\\\\]');
        const regex = new RegExp('[\\\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\\+/g, ' '));
    }


    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®åˆæœŸåŒ–ã¨åˆæœŸå‡¦ç† ---
    const game = new GameManager();
    let gameLoopRef = null;
    let currentSettings = { type: null, location: null, maxSeats: 0, currentSeats: 0, initialCost: 0, initialMenu: [] };
    let isInfiniteAsset = false; // ç„¡åˆ¶é™ãƒãƒ¼ãƒˆã¯åˆ¥ã§ç®¡ç†
    let isInputLocked = false; // æ–°ã—ã„å…¥åŠ›ãƒ­ãƒƒã‚¯ãƒ•ãƒ©ã‚°ã®è¿½åŠ 

    window.onload = () => {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãƒãƒ¼ãƒˆãƒ•ãƒ©ã‚°ãŒã‚ã‚‹å ´åˆã¯ã€å¼·åˆ¶çš„ã«è¨­å®šç”»é¢ã«é£›ã°ã™
        if (getUrlParameter('cheat') === 'true') {
            showScreen('start-screen');
            // ã“ã“ã§ã¯åˆæœŸåŒ–ã®ã¿è¡Œã„ã€startGameã§è³‡ç”£ã‚’è¨­å®š
        } else {
            // é€šå¸¸èµ·å‹•
            checkSavedGame();
        }
    };
</script>

</body>
</html>
