<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>飲食店経営シミュレーション ver1.4 (改良版)</title>
<style>
  /* 基本レイアウト */
  body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f4f6f8; margin:0; padding:18px; display:flex; justify-content:center;}
  #game-container{width:95%; max-width:1100px; background:#fff; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,0.08); padding:18px;}
  h1, h2{color:#2e7d32; margin:8px 0;}
  .button{background:#2196f3;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin:4px;}
  .danger{background:#f44336;}
  #game-ui{display:grid; grid-template-columns:3fr 1fr; gap:12px; grid-template-areas:"header header" "main sidebar";}
  #header{grid-area:header; display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; border-bottom:1px solid #eee;}
  #main{grid-area:main; background:#e8f5e9; padding:14px; border-radius:8px; min-height:420px;}
  #sidebar{grid-area:sidebar; background:#fafafa; padding:12px; border-radius:8px; border:1px solid #eee;}
  #seat-map{display:flex; flex-wrap:wrap; gap:10px;}
  .seat{min-width:120px; padding:10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); text-align:center; background:#fff;}
  .seat-empty{background:#e8fef0; border:1px solid #66bb6a;}
  .seat-wait{background:#fffbe6; border:1px solid #ffb300;}
  .seat-eat{background:#fff0f0; border:1px solid #f44336;}
  .customer-img{width:60px;height:60px;object-fit:cover;border-radius:8px; display:block;margin:8px auto;}
  .speech{display:inline-block;background:#fff;border-radius:12px;padding:8px 10px;box-shadow:0 2px 8px rgba(0,0,0,0.12); margin-top:6px;}
  .speech:after{content:''; position:absolute; width:0;height:0;}
  #log-terop{position:fixed; left:50%; bottom:0; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:8px 14px; border-radius:8px 8px 0 0; opacity:0; transition:opacity .4s; z-index:9999;}
  /* モーダル */
  .modal{display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.45); z-index:1000; align-items:center; justify-content:center;}
  .modal .content{background:#fff; padding:14px; border-radius:8px; width:90%; max-width:640px; box-shadow:0 8px 26px rgba(0,0,0,0.18);}
  /* レジスタイル */
  #register-display{background:#111;color:#0f0;padding:12px;border-radius:8px;font-size:20px;text-align:right;}
  .reg-btn{padding:10px;border-radius:6px;font-size:16px;border:none;background:#e0e0e0;cursor:pointer;}
  .draggable-coin{display:inline-block;padding:6px 10px;border-radius:6px;background:#fafafa;border:1px solid #bbb;cursor:grab;margin:6px;}
  .zone{min-height:68px;padding:8px;border-radius:8px;border:1px dashed #bbb;background:#fff;}
  .small{font-size:0.9em;color:#444;}
  /* responsive */
  @media(max-width:800px){ #game-ui{grid-template-columns:1fr; grid-template-areas:"header" "main" "sidebar";} }
</style>
</head>
<body>
<div id="game-container">
  <h1>飲食店経営シミュレーション ver1.4（改良）</h1>

  <div id="game-ui">
    <div id="header">
      <div>
        <button class="button" onclick="openMenu()">メニュー</button>
        <button class="button" onclick="openSettings()">設定</button>
        <button class="button" onclick="openItems()">アイテム</button>
        <button class="button" onclick="saveGame()">セーブ</button>
        <button class="button danger" onclick="quitGame()">やめる</button>
      </div>
      <div>
        <span id="day-display">Day 1</span> | <span id="time-display">00:00</span>
      </div>
      <div id="status-display">
        <span id="asset-display">資産: 15,000,000円</span><br>
        <span id="reputation-display">評判: ★3.0</span>
      </div>
    </div>

    <div id="main">
      <h2>店舗フロア（<span id="store-type-display">—</span>）</h2>
      <div id="seat-map"></div>
    </div>

    <div id="sidebar">
      <h3>情報</h3>
      <p class="small">高級ゴミ箱: <span id="garbage-can-status">未</span></p>
      <h4>従業員 (<span id="employee-count">0</span>)</h4>
      <div id="employee-status"></div>
      <hr>
      <h4>操作</h4>
      <div>
        注文モード:
        <label><input type="radio" name="orderMode" value="auto" checked onchange="setOrderMode('auto')"> 自動</label>
        <label><input type="radio" name="orderMode" value="manual" onchange="setOrderMode('manual')"> 手動</label>
      </div>
      <div style="margin-top:8px;">
        会計モード:
        <label><input type="radio" name="payMode" value="auto" checked onchange="setPayMode('auto')"> 自動</label>
        <label><input type="radio" name="payMode" value="manual" onchange="setPayMode('manual')"> 手動</label>
      </div>
      <hr>
      <h4>待機タスク</h4>
      <p class="small">注文待ち: <span id="wait-order-count">0</span></p>
      <p class="small">調理待ち: <span id="wait-cook-count">0</span></p>
      <hr>
      <h4>待ち客</h4>
      <div id="waiting-customer-details" class="small"></div>
    </div>
  </div>
</div>

<div id="log-terop"></div>

<!-- モーダル: レジ -->
<div id="register-modal" class="modal">
  <div class="content" style="max-width:560px;">
    <h2>レジ会計</h2>
    <div id="register-display">0</div>

    <!-- 電卓 -->
    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin:10px 0;">
      <button class="reg-btn" data-v="7">7</button>
      <button class="reg-btn" data-v="8">8</button>
      <button class="reg-btn" data-v="9">9</button>
      <button class="reg-btn" data-v="C">C</button>

      <button class="reg-btn" data-v="4">4</button>
      <button class="reg-btn" data-v="5">5</button>
      <button class="reg-btn" data-v="6">6</button>
      <button class="reg-btn" data-v="⌫">⌫</button>

      <button class="reg-btn" data-v="1">1</button>
      <button class="reg-btn" data-v="2">2</button>
      <button class="reg-btn" data-v="3">3</button>
      <button class="reg-btn" data-v="ENTER">ENTER</button>

      <button class="reg-btn" data-v="0">0</button>
      <button class="reg-btn" data-v="00">00</button>
      <button class="reg-btn" data-v=".">.</button>
      <button class="reg-btn" data-v="OK">OK</button>
    </div>

    <h3>客が出したお金</h3>
    <div id="customer-money" class="zone"></div>

    <h3>レジに入れる（ここにドラッグ）</h3>
    <div id="player-insert" class="zone">ここにドラッグ</div>

    <h3>お釣り（ここからドラッグで渡す）</h3>
    <div id="change-zone" class="zone"></div>

    <h3>客の受け取り（ここにドラッグ）</h3>
    <div id="customer-receive" class="zone"></div>

    <div style="text-align:right; margin-top:8px;">
      <button class="button" onclick="closeRegister()">閉じる</button>
    </div>
  </div>
</div>

<!-- 設定 / メニュー / アイテム モーダル（簡易） -->
<div id="settings-modal" class="modal"><div class="content"><h2>設定</h2><div id="employee-list-settings"></div><div style="margin-top:8px;"><button class="button" onclick="addEmployee('マスター')">マスター (日給45万)</button><button class="button" onclick="addEmployee('ベテラン')">ベテラン (30万)</button><button class="button" onclick="addEmployee('標準')">標準 (20万)</button><button class="button" onclick="addEmployee('ポンコツ')">ポンコツ (10万)</button></div><div style="text-align:right;margin-top:10px;"><button class="button" onclick="closeModal('settings-modal')">閉じる</button></div></div></div>

<div id="menu-modal" class="modal"><div class="content"><h2>メニュー</h2><div id="current-menu-list"></div><div style="text-align:right;margin-top:10px;"><button class="button" onclick="closeModal('menu-modal')">閉じる</button></div></div></div>

<div id="item-modal" class="modal"><div class="content"><h2>アイテム</h2><div id="item-list-purchase"></div><div style="text-align:right;margin-top:10px;"><button class="button" onclick="closeModal('item-modal')">閉じる</button></div></div></div>

<script>
/* --------------------
   データ / 初期値
   -------------------- */
const MENU_DATA = {
  FastFood:[
    {name:"チーズバーガー", basePrice:500, cost:200},
    {name:"ポテトM", basePrice:300, cost:70}
  ],
  Restaurant:[
    {name:"マルゲリータ", basePrice:1200, cost:350}
  ]
};
const ITEM_DATA = { GARBAGE_CAN:{name:"高級ゴミ箱", cost:10000, effect:"満足度低下抑制"} };
const CUSTOMER_IMAGES = [
  "https://i.ibb.co/2YPFhJ1D/IMG-2529.jpg",
  "https://i.ibb.co/p6DSzpHQ/IMG-2529.jpg",
  "https://i.ibb.co/BHW5cMvS/IMG-2529.jpg",
  "https://i.ibb.co/7tjqbkkX/IMG-2529.jpg",
  "https://i.ibb.co/Xkkr114y/IMG-2529.jpg"
];

const SAVE_KEY = "restaurant_v1_4_save";
const GLOBAL_MAX_SEATS = 20;

/* --------------------
   クラス定義
   -------------------- */
class MenuItem { constructor(name, price, cost){ this.name=name; this.currentPrice=price; this.cost=cost; } }
class Employee {
  constructor(grade, id = null){
    this.grade = grade;
    this.id = id || Math.random().toString(36).slice(2,9);
    switch(grade){
      case "マスター": this.speedMultiplier=2.5; this.dailyCost=450000; break;
      case "ベテラン": this.speedMultiplier=1.5; this.dailyCost=300000; break;
      case "標準": this.speedMultiplier=1.0; this.dailyCost=200000; break;
      case "ポンコツ": this.speedMultiplier=0.5; this.dailyCost=100000; break;
      default: this.speedMultiplier=1.0; this.dailyCost=200000;
    }
  }
  getProcessTime(base){ return base / this.speedMultiplier; }
}
class Customer {
  constructor(numPeople, orderType, seatId, menuList){
    this.id = Math.random().toString(36).slice(2,9);
    this.numPeople = numPeople;
    this.orderType = orderType; // 'タブレット' or '手動'
    this.seatId = seatId;
    this.status = 'WaitOrder'; // WaitOrder, WaitCook, Eating, Paying, Done
    this.patience = 60;
    this.mealTimeLeft = 30;
    this.image = CUSTOMER_IMAGES[Math.floor(Math.random()*CUSTOMER_IMAGES.length)];
    if(menuList && menuList.length>0){
      const idx = Math.floor(Math.random()*menuList.length);
      this.orderedItem = menuList[idx];
      this.billAmount = this.numPeople * this.orderedItem.currentPrice;
      this.totalCost = this.numPeople * this.orderedItem.cost;
    } else {
      this.orderedItem = null;
      this.billAmount = 0;
      this.totalCost = 0;
    }
  }
  update(dt){
    if(this.status === 'Eating'){ this.mealTimeLeft -= dt; if(this.mealTimeLeft <= 0) this.status = 'Paying'; }
    const baseRate = this.status==='Eating' ? 0.3 : 1.0;
    const garbageEffect = game.hasGarbageCan ? 0.8 : 1.0;
    this.patience -= dt * baseRate * garbageEffect;
    if(this.patience <= 0) this.status = 'Done';
  }
}

/* --------------------
   GameManager
   -------------------- */
class GameManager {
  constructor(){
    this.asset = 15000000;
    this.reputation = 3.0;
    this.day = 1;
    this.time = 0;
    this.isPaused = false;
    this.isGameRunning = false;
    this.storeType = null;
    this.currentSeats = 0;
    this.seatsData = [];
    this.customers = [];
    this.employees = [];
    this.menu = [];
    this.cookQueue = [];
    this.employeeTasks = [];
    this.customerSpawnTimer = 0;
    this.customerSpawnInterval = 10;
    this.hasGarbageCan = false;
    // 設定: 手動/自動
    this.orderMode = 'auto'; // 'auto' or 'manual'
    this.payMode = 'auto';
  }

  resetGame(){
    this.asset = 15000000; this.reputation = 3.0; this.day = 1; this.time = 0; this.isPaused=false; this.isGameRunning=false;
    this.storeType = null; this.currentSeats = 0; this.seatsData=[]; this.customers=[]; this.employees=[]; this.menu=[];
    this.cookQueue=[]; this.employeeTasks=[]; this.customerSpawnTimer=0; this.customerSpawnInterval=10; this.hasGarbageCan=false;
  }

  initializeGame(settings){
    this.isGameRunning = true;
    this.storeType = settings.type;
    this.currentSeats = settings.currentSeats;
    this.menu = settings.initialMenu.map(i=> new MenuItem(i.name, i.basePrice, i.cost));
    this.seatsData = [];
    for(let i=0;i<this.currentSeats/2;i++) this.seatsData.push({id:i+1,isOccupied:false,numGuests:0,customerId:null});
    if(this.employees.length === 0) this.employees = [ new Employee('標準'), new Employee('標準'), new Employee('ベテラン') ];
    this.customers = []; this.cookQueue=[]; this.employeeTasks=[];
    document.getElementById('store-type-display').textContent = this.storeType;
    this.updateDisplay();
  }

  update(dt){
    if(this.isPaused) return;
    const GAME_SPEED = 2.0;
    this.time += dt * GAME_SPEED;
    if(this.time >= 600){ this.time = 600; this.endOfDay(); return; }
    this.spawnCustomer(dt);
    this.customers.forEach(c => {
      c.update(dt);
      if(c.status === 'Paying'){
        if(!c._payOpen){
          c._payOpen = true;
          // 会計モードによって処理
          if(this.payMode === 'auto') {
            // 自動会計: 即時処理
            this.removeCustomer(c, c.seatId, true);
            terop(`席${c.seatId}：自動会計処理`);
          } else {
            // 手動会計: レジを開く（プレイヤー処理）
            startCashier(c);
          }
        }
      } else if(c.status === 'Done'){
        this.removeCustomer(c, c.seatId, false);
      }
    });
    this.processEmployeeTasks(dt);
    this.updateDisplay();
  }

  spawnCustomer(dt){
    this.customerSpawnTimer += dt;
    if(this.customerSpawnTimer < this.customerSpawnInterval) return;
    this.customerSpawnTimer = 0;
    const free = this.seatsData.find(s=>!s.isOccupied);
    if(!free){ terop('満席：お客様が帰った'); return; }
    const num = Math.floor(Math.random()*4)+1;
    const orderType = Math.random() < 0.7 ? 'タブレット' : '手動';
    const c = new Customer(num, orderType, free.id, this.menu);
    if(!c.orderedItem){ terop('メニュー未設定で客が帰った'); return; }
    free.isOccupied = true; free.numGuests = c.numPeople; free.customerId = c.id;
    this.customers.push(c);
    terop(`${num}人組（${orderType}）が来店。席${c.seatId}に着席。`);
    // 注文動作
    if(orderType === 'タブレット'){
      c.status = 'WaitCook';
      this.cookQueue.push({customer:c});
    } else {
      c.status = 'WaitOrder';
      // 手動モードが auto なら自動で受付
      if(this.orderMode === 'auto'){
        c.status = 'WaitCook';
        this.cookQueue.push({customer:c});
        terop(`席${c.seatId}の手動注文を自動受付しました`);
      }
    }
    this.customerSpawnInterval = Math.random()*10 + 5;
  }

  removeCustomer(customer, seatId, paid){
    const seat = this.seatsData.find(s=>s.id===seatId);
    if(seat){ seat.isOccupied=false; seat.numGuests=0; seat.customerId=null; }
    this.customers = this.customers.filter(x=>x!==customer);
    if(paid){
      const profit = Math.max(0, customer.billAmount - customer.totalCost);
      this.asset += profit;
      terop(`席${seatId} 会計完了。利益 +${profit.toLocaleString()}円`);
    } else {
      this.asset -= customer.totalCost;
      this.reputation = Math.max(1.0, this.reputation - 0.1);
      terop(`席${seatId} 客が怒って帰った。損失 ${customer.totalCost.toLocaleString()}円`);
    }
  }

  processEmployeeTasks(dt){
    this.employees.forEach(emp => {
      let task = this.employeeTasks.find(t=>t.employee === emp);
      if(task){
        task.timeLeft -= dt;
        if(task.timeLeft <= 0){
          this.completeTask(task);
          this.employeeTasks = this.employeeTasks.filter(t=>t !== task);
          task = null;
        }
      }
      if(!task){
        // 優先: 手動注文受付
        const manual = this.customers.find(c=>c.status === 'WaitOrder' && c.orderType === '手動');
        if(manual && this.orderMode === 'auto'){
          // すで handled earlier; skip
        }
        if(manual && this.orderMode === 'manual'){
          // 従業員は注文受付ができるが、プレイヤーが確認ボタンで入れる仕様のため
          // ここはプレイヤー優先で待機する（従業員が勝手にとらない）
        }
        // 次に調理
        if(this.cookQueue.length > 0){
          const item = this.cookQueue.shift();
          const t = { employee:emp, taskType:'cooking', target: item.customer, timeLeft: emp.getProcessTime(15) };
          this.employeeTasks.push(t);
          // set status to indicate cooking in progress to avoid duplicates
        }
      }
    });
  }

  completeTask(task){
    const customer = task.target;
    if(task.taskType === 'order_taking'){
      this.cookQueue.push({customer:customer});
      terop(`注文受付完了：席${customer.seatId}の注文を調理キューへ`);
    } else if(task.taskType === 'cooking'){
      customer.status = 'Eating';
      terop(`調理完了：席${customer.seatId}へ提供開始`);
    }
  }

  updateDisplay(){
    document.getElementById('asset-display').textContent = `資産: ${this.asset.toLocaleString()}円`;
    document.getElementById('reputation-display').textContent = `評判: ★${this.reputation.toFixed(1)}`;
    const minutes = Math.floor(this.time/60);
    const seconds = Math.floor(this.time%60);
    document.getElementById('time-display').textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    document.getElementById('day-display').textContent = `Day ${this.day}`;

    // 席の描画
    const seatMap = document.getElementById('seat-map');
    seatMap.innerHTML = this.seatsData.map(seat=>{
      let cls = 'seat-empty';
      let inner = `<div>席 ${seat.id}</div>`;
      if(seat.isOccupied){
        const c = this.customers.find(x=>x.id === seat.customerId);
        if(c){
          if(c.status === 'Eating' || c.status === 'Paying') cls = 'seat-eat';
          else cls = 'seat-wait';
          inner += `<img src="${c.image}" class="customer-img" alt="客">`;
          inner += `<div class="small">${c.orderedItem ? c.orderedItem.name : '-'} x ${c.numPeople}</div>`;
          // 吹き出し（状態に応じた会話）
          if(c.status === 'WaitOrder'){
            inner += `<div class="speech">注文待ち</div>`;
          } else if(c.status === 'Paying'){
            inner += `<div class="speech">会計お願いします: ${c.billAmount.toLocaleString()}円</div>`;
          } else if(c.status === 'Eating'){
            inner += `<div class="speech">食事中</div>`;
          }
        }
      }
      return `<div class="seat ${cls}" data-seat="${seat.id}">${inner}</div>`;
    }).join('');

    document.getElementById('garbage-can-status').textContent = this.hasGarbageCan ? '購入済' : '未';
    document.getElementById('employee-count').textContent = this.employees.length || 0;
    document.getElementById('wait-order-count').textContent = this.customers.filter(c=>c.status==='WaitOrder' && c.orderType==='手動').length;
    document.getElementById('wait-cook-count').textContent = this.cookQueue.length;

    // 従業員リスト
    document.getElementById('employee-status').innerHTML = this.employees.map(e=>{
      const t = this.employeeTasks.find(tt=>tt.employee===e);
      const desc = t ? (t.taskType==='cooking' ? `調理中 (${t.timeLeft.toFixed(1)}s)` : `注文受付中 (${t.timeLeft.toFixed(1)}s)`) : '待機中';
      return `<div class="small"><strong>${e.grade}</strong> (${e.dailyCost.toLocaleString()}円) — ${desc}</div>`;
    }).join('');

    // 待ち客詳細（サイド）
    const waiting = document.getElementById('waiting-customer-details');
    waiting.innerHTML = '';
    const waitList = this.customers.filter(c => c.status !== 'Eating' && c.status !== 'Paying');
    if(waitList.length === 0) waiting.innerHTML = '<div class="small">待ち客なし</div>';
    waitList.forEach(c=>{
      const statusText = c.status === 'WaitOrder' ? '注文待ち' : (c.status === 'WaitCook' ? '調理待ち' : c.status);
      waiting.innerHTML += `<div style="border-bottom:1px dashed #eee;padding:6px 0;">
        <img src="${c.image}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;vertical-align:middle;margin-right:8px;">
        席${c.seatId} (${c.numPeople}人) — ${statusText}<br>
        <span class="small">品: ${c.orderedItem ? c.orderedItem.name : '-'} (${c.billAmount.toLocaleString()}円)</span>
        ${c.orderType==='手動' && c.status==='WaitOrder' ? `<br><button class="button" onclick="playerConfirmOrder('${c.id}')">注文を確認してキューに登録</button>` : ''}
      </div>`;
    });
  }

  endOfDay(){
    this.isPaused = true;
    terop('営業終了');
    const totalPay = this.employees.reduce((s,e)=>s+e.dailyCost, 0);
    this.asset -= totalPay;
    setTimeout(()=>{
      alert(`Day ${this.day} 終了。給与合計: ${totalPay.toLocaleString()}円`);
      this.day++;
      this.time = 0;
      this.isPaused = false;
      this.customers = [];
      this.cookQueue = [];
      this.employeeTasks = [];
      this.customerSpawnTimer = 0;
      if(this.isGameRunning) gameLoop(0);
    }, 500);
  }

  getGameData(){
    return {
      asset:this.asset, reputation:this.reputation, day:this.day,
      employees: this.employees.map(e=>({id:e.id, grade:e.grade})),
      menu: this.menu.map(m=>({name:m.name,currentPrice:m.currentPrice,cost:m.cost})),
      settings: { type: this.storeType, currentSeats: this.currentSeats },
      hasGarbageCan: this.hasGarbageCan,
      currentSeats: this.currentSeats,
      seatsData: this.seatsData
    };
  }
}

/* --------------------
   インスタンス / グローバル
   -------------------- */
const game = new GameManager();
let gameLoopRef = null;
let currentSettings = { type:'FastFood', currentSeats:4, initialMenu: MENU_DATA['FastFood'].slice(0,2) };

/* --------------------
   UI / 操作関数
   -------------------- */
function openMenu(){ showModal('menu-modal'); updateMenuUI(); }
function openSettings(){ showModal('settings-modal'); updateEmployeeUI(); }
function openItems(){ showModal('item-modal'); updateItemUI(); }

function showModal(id){ document.getElementById(id).style.display='flex'; game.isPaused = true; }
function closeModal(id){ document.getElementById(id).style.display='none'; game.isPaused = false; if(game.isGameRunning) gameLoop(0); }

function startGame(){
  game.resetGame();
  game.initializeGame(currentSettings);
  game.asset -= 0; // 初期差し引きなどあれば
  game.isGameRunning = true;
  showInGame();
  terop('ゲーム開始');
  showWarningOnExit();
  if(gameLoopRef) cancelAnimationFrame(gameLoopRef);
  gameLoop(0);
}
function showInGame(){ document.getElementById('store-type-display').textContent = currentSettings.type; document.getElementById('game-container').scrollIntoView(); showModalCloseIfAny(); document.getElementById('asset-display').textContent = `資産: ${game.asset.toLocaleString()}円`; }

function showModalCloseIfAny(){ /* nothing */ }

function gameLoop(ts){
  const last = gameLoop.lastTime || ts;
  const dt = (ts - last)/1000;
  gameLoop.lastTime = ts;
  game.update(Math.max(0, dt));
  if(game.isGameRunning && !game.isPaused) gameLoopRef = requestAnimationFrame(gameLoop);
}

/* --------------------
   従業員操作
   -------------------- */
function updateEmployeeUI(){
  const el = document.getElementById('employee-list-settings');
  el.innerHTML = '';
  game.employees.forEach(e=>{
    el.innerHTML += `<div style="margin-bottom:6px;">${e.grade} — 日給:${e.dailyCost.toLocaleString()}円 <button class="button" onclick="fireEmployee('${e.id}')">解雇</button></div>`;
  });
}
function addEmployee(grade){
  game.employees.push(new Employee(grade));
  updateEmployeeUI();
  terop(`${grade}を雇用`);
}
function fireEmployee(id){
  game.employees = game.employees.filter(e=>e.id!==id);
  updateEmployeeUI();
  terop('従業員を解雇');
}

/* --------------------
   注文：プレイヤーが確認してキュー登録（手動注文）
   -------------------- */
function playerConfirmOrder(customerId){
  const c = game.customers.find(x=>x.id===customerId);
  if(!c) return;
  c.status = 'WaitCook';
  game.cookQueue.push({customer:c});
  terop(`プレイヤーが席${c.seatId}の注文を確認してキューに登録した`);
}

/* --------------------
   会計（レジ）フロー
   -------------------- */
let currentCashierCustomer = null;

function startCashier(customer){
  currentCashierCustomer = customer;
  // レジモーダルを開く
  showModal('register-modal');
  // 客の出すお金を生成して customer-money に表示
  const paid = generateCustomerPayment(customer.billAmount);
  customer._paidAmount = paid;
  const custMoney = document.getElementById('customer-money');
  custMoney.innerHTML = '';
  const arr = toCoinArray(paid);
  arr.forEach(v=>{
    const d = document.createElement('div');
    d.className = 'draggable-coin cust-coin';
    d.draggable = true;
    d.dataset.value = v;
    d.textContent = v + "円";
    custMoney.appendChild(d);
  });
  // クリアプレイヤー挿入欄
  document.getElementById('player-insert').innerHTML = 'ここにドラッグ';
  document.getElementById('change-zone').innerHTML = '';
  document.getElementById('customer-receive').innerHTML = '';
  document.getElementById('register-display').textContent = '0';
  terop(`会計: 席${customer.seatId} 合計 ${customer.billAmount}円。客が渡す金額 ${paid}円`);
}

function generateCustomerPayment(amount){
  const opts = [amount, amount + 100, amount + 500, amount + 1000, amount + 2000];
  return opts[Math.floor(Math.random()*opts.length)];
}
function toCoinArray(amount){
  const coins = [10000,5000,1000,500,100,50,10,5,1];
  const res = [];
  let rem = amount;
  for(const c of coins){
    while(rem >= c){ res.push(c); rem -= c; }
  }
  return res;
}

/* ドラッグ&ドロップ（基本） */
let dragElem = null;
document.addEventListener('dragstart', e=>{
  if(e.target && e.target.dataset && e.target.dataset.value){
    dragElem = e.target;
  }
});
document.addEventListener('dragover', e=>{
  const zone = e.target.closest('.zone');
  if(zone) e.preventDefault();
});
document.addEventListener('drop', e=>{
  e.preventDefault();
  if(!dragElem) return;
  const zone = e.target.closest('.zone');
  if(!zone) return;

  // player-insert には客のコイン（cust-coin）を入れる動作のみ許可
  if(zone.id === 'player-insert'){
    if(dragElem.classList.contains('cust-coin')){
      zone.appendChild(dragElem);
      updateRegisterDisplay();
      checkForChange();
    }
  } else if(zone.id === 'change-zone'){
    // change-zone には自動生成されたお釣りコインが追加されることを想定（ユーザーがドラッグしてもOK）
    zone.appendChild(dragElem);
  } else if(zone.id === 'customer-receive'){
    // プレイヤーが change-zone -> customer-receive に渡す
    zone.appendChild(dragElem);
    checkChangeDelivered();
  } else if(zone.id === 'customer-money'){
    // 何もしない（元に戻す）
    zone.appendChild(dragElem);
    updateRegisterDisplay();
  }
});

/* 電卓ボタン */
document.addEventListener('click', e=>{
  if(e.target.classList.contains('reg-btn')){
    const v = e.target.dataset.v;
    let disp = document.getElementById('register-display').textContent || '0';
    if(v === 'C'){ disp = '0'; }
    else if(v === '⌫'){ disp = disp.slice(0,-1) || '0'; }
    else if(v === 'ENTER' || v === 'OK'){
      // ENTER は補助。ここでは合計を客が置いた金額として扱う
    } else {
      if(disp === '0') disp = '' + v;
      else disp = disp + v;
    }
    document.getElementById('register-display').textContent = disp;
  }
});

/* 登録された金額の算出（player-insert） */
function updateRegisterDisplay(){
  const area = document.getElementById('player-insert');
  let sum = 0;
  area.querySelectorAll('[data-value]').forEach(n=>{
    sum += Number(n.dataset.value);
  });
  // text 形式に反映
  document.getElementById('register-display').textContent = sum;
}

/* 支払額が入ったらお釣り用意 */
function checkForChange(){
  if(!currentCashierCustomer) return;
  const inserted = Number(document.getElementById('register-display').textContent) || 0;
  const paid = currentCashierCustomer._paidAmount || 0;
  const bill = currentCashierCustomer.billAmount || 0;
  // プレイヤーは「客の出した金額」をレジに入れる必要あり -> 客が渡した金額を全部入れた時点でお釣りを用意する
  // 判定: player-insert 内の合計が paid と等しいまたは大きければお釣り生成
  if(inserted >= paid){
    const change = inserted - bill;
    const zone = document.getElementById('change-zone');
    zone.innerHTML = '';
    if(change > 0){
      const changeCoins = toCoinArray(change);
      changeCoins.forEach(v=>{
        const d = document.createElement('div');
        d.className = 'draggable-coin change-coin';
        d.draggable = true;
        d.dataset.value = v;
        d.textContent = v + '円';
        zone.appendChild(d);
      });
      terop(`お釣り ${change.toLocaleString()}円 を用意しました。`);
    } else {
      terop('お釣りはありません。会計は完了できます。');
    }
  }
}

/* プレイヤーが渡したお釣りを顧客受け取り欄でチェック */
function checkChangeDelivered(){
  if(!currentCashierCustomer) return;
  const receive = document.getElementById('customer-receive');
  let sum = 0;
  receive.querySelectorAll('[data-value]').forEach(n=> sum += Number(n.dataset.value));
  const paid = currentCashierCustomer._paidAmount || 0;
  const bill = currentCashierCustomer.billAmount || 0;
  const requiredChange = paid - bill;
  if(sum === requiredChange){
    terop('お釣り全部渡した。会計完了。');
    // レジを閉じて顧客退店
    const cust = currentCashierCustomer;
    currentCashierCustomer = null;
    closeRegister();
    game.removeCustomer(cust, cust.seatId, true);
  } else {
    terop(`お釣りが足りない：${sum}/${requiredChange}円`);
  }
}

function closeRegister(){
  closeModal('register-modal');
}

/* --------------------
   モード切替
   -------------------- */
function setOrderMode(m){ game.orderMode = m; terop(`注文モード: ${m}`); }
function setPayMode(m){ game.payMode = m; terop(`会計モード: ${m}`); }

/* --------------------
   セーブ/ロード/その他
   -------------------- */
function saveGame(){
  try{ localStorage.setItem(SAVE_KEY, JSON.stringify(game.getGameData())); terop('セーブ完了'); } catch(e){ terop('セーブ失敗'); }
}
function loadGame(){
  const s = localStorage.getItem(SAVE_KEY);
  if(!s){ alert('セーブデータなし'); return; }
  const d = JSON.parse(s);
  // 最低限復元
  currentSettings.type = d.settings.type || currentSettings.type;
  currentSettings.currentSeats = d.currentSeats || currentSettings.currentSeats;
  game.resetGame();
  game.initializeGame({ type: currentSettings.type, currentSeats: currentSettings.currentSeats, initialMenu: MENU_DATA[currentSettings.type].slice(0,2) });
  game.asset = d.asset || game.asset;
  game.employees = (d.employees || []).map(e => new Employee(e.grade, e.id));
  if(d.menu) game.menu = d.menu.map(m=> new MenuItem(m.name, m.currentPrice || m.currentPrice, m.cost || 0));
  if(d.seatsData) game.seatsData = d.seatsData;
  terop('ロード完了');
  if(gameLoopRef) cancelAnimationFrame(gameLoopRef);
  gameLoop(0);
}

function loadGameFromHome(){ loadGame(); }

function quitGame(){
  if(confirm('ゲームを終了してホームに戻る？')) {
    game.isGameRunning = false;
    if(gameLoopRef) cancelAnimationFrame(gameLoopRef);
    location.reload();
  }
}

/* --------------------
   ヘルパー / UI 更新
   -------------------- */
function terop(msg){
  const el = document.getElementById('log-terop');
  el.textContent = msg;
  el.style.opacity = 1;
  setTimeout(()=> el.style.opacity = 0, 3000);
}

/* 小さなUI初期化 */
function updateMenuUI(){
  const el = document.getElementById('current-menu-list');
  el.innerHTML = '';
  const arr = game.menu.length ? game.menu : currentSettings.initialMenu.map(i=> new MenuItem(i.name, i.basePrice, i.cost));
  arr.forEach(m=> el.innerHTML += `<div style="margin-bottom:6px;">${m.name} — ${m.currentPrice}円</div>`);
}
function updateItemUI(){
  const el = document.getElementById('item-list-purchase');
  el.innerHTML = '';
  Object.keys(ITEM_DATA).forEach(k=>{
    const it = ITEM_DATA[k];
    el.innerHTML += `<div style="margin-bottom:6px;">${it.name} — ${it.cost.toLocaleString()}円 <button class="button" onclick="purchaseItem('${k}')">購入</button></div>`;
  });
}
function purchaseItem(key){
  const it = ITEM_DATA[key];
  if(game.asset < it.cost){ terop('お金が足りない'); return; }
  game.asset -= it.cost;
  if(key === 'GARBAGE_CAN') game.hasGarbageCan = true;
  updateItemUI();
  terop(`${it.name} を購入`);
}

/* 従業員 UI 初回更新 */
updateEmployeeUI();

/* --------------------
   起動処理（開始用）
   -------------------- */
// 初期設定で自動開始してほしければここで startGame() を呼ぶ。
// でも今回はホーム状態を維持。ユーザーが startGame を押したいならボタンを用意する。
// ここでは簡易的に自動開始：
startGame();

/* --------------------
   補助: プレイヤーが注文確認ボタンから呼ぶ関数（手動注文をプレイヤーが確認してキューに入れる）
   -------------------- */
function playerConfirmOrder(customerId){
  playerConfirmOrder; // placeholder (実装済: playerConfirmOrder above)
}

/* --------------------
   終了時の警告
   -------------------- */
function showWarningOnExit(){
  window.onbeforeunload = function(){
    if(game && game.isGameRunning) return 'ゲーム進行が失われます。よいですか？';
  };
}
</script>
</body>
</html>
